<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script defer src="https://www.googletagmanager.com/gtag/js?id=G-MBBQWJWF2X"></script>
<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-MBBQWJWF2X');
  });
</script>
<!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="B+ Tree Database in Modern C++" />
<meta name="author" content="Theodore Cooper" />
<meta property="og:locale" content="en" />
<meta name="description" content="A B+ Tree based local database in Modern C++." />
<meta property="og:description" content="A B+ Tree based local database in Modern C++." />
<link rel="canonical" href="https://the0cp.github.io/posts/database/" />
<meta property="og:url" content="https://the0cp.github.io/posts/database/" />
<meta property="og:site_name" content="Blog the0cp" />
<meta property="og:image" content="https://the0cp.github.io/assets/img/blog/db/bplus.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-05T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://the0cp.github.io/assets/img/blog/db/bplus.jpg" />
<meta property="twitter:title" content="B+ Tree Database in Modern C++" />
<meta name="twitter:site" content="@T_Ccooper" />
<meta name="twitter:creator" content="@T_Ccooper" />
<meta name="google-site-verification" content="BTGobNZt1lO93pNn2A8IVOLeIxK5oTJD2uo9iz1N7kA" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Theodore Cooper","url":"https://github.com/the0cp/"},"dateModified":"2024-12-05T00:00:00+09:00","datePublished":"2024-12-05T00:00:00+09:00","description":"A B+ Tree based local database in Modern C++.","headline":"B+ Tree Database in Modern C++","image":"https://the0cp.github.io/assets/img/blog/db/bplus.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://the0cp.github.io/posts/database/"},"url":"https://the0cp.github.io/posts/database/"}</script>
<!-- End Jekyll SEO tag -->


  <title>B+ Tree Database in Modern C++ | Blog | the0cp
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Blog | the0cp">
<meta name="application-name" content="Blog | the0cp">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Blog | the0cp</a>
    <p class="site-subtitle fst-italic mb-0">Talk is cheap, show me the code.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/the0cp"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/T_Ccooper"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['ccooperr2005','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>B+ Tree Database in Modern C++</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>B+ Tree Database in Modern C++</h1>
    
      <p class="post-desc fw-light mb-4">A B+ Tree based local database in Modern C++.
</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1733324400"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Dec  5, 2024
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/blog/db/bplus.jpg" class="popup img-link preview-img shimmer"><img src="/assets/img/blog/db/bplus.jpg"  alt="Preview Image" width="1200" height="630"  loading="lazy"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://github.com/the0cp/">Theodore Cooper</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="3964 words"
>
  <em>22 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">B+ Tree Database in Modern C++</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">B+ Tree Database in Modern C++</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <h2 id="what-is-b-tree"><span class="me-2">What is B+ Tree</span><a href="#what-is-b-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>A B+ Tree is an m-ary tree with a variable but often large number of children per node.
A B+ Tree often consists of a root, internal nodes and leaf nodes. It can be viewed as a variation of B-Tree in which each node contains only keys instead of key-value pairs, and to which an additional level is added at the buttom with linked leaves.</p>

<p><a href="/assets/img/blog/db/Bplustree.png" class="popup img-link  shimmer"><img src="/assets/img/blog/db/Bplustree.png" alt="bplus" loading="lazy"></a></p>

<p>The primary value of a B+ tree is in storing data for efficient retrieval in a block-oriented filesystems. <em>XFS</em>, <em>BFS</em>, <em>NSS</em>, etc. all use B+ Tree for metadata indexing; <em>BFS</em> and <em>NTFS</em> also uses B+ Tree for storing directories.</p>

<h2 id="features-of-b-tree"><span class="me-2">Features of B+ Tree</span><a href="#features-of-b-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<ul>
  <li>
    <p><strong>Balanced</strong>: B+ Tree is self-balancing, which means that as the record is inserted or removed from the tree, it should be able to automatically adjust itself to rebalance its structure and keep the height low.</p>
  </li>
  <li>
    <p><strong>Multi-level</strong>: B+ Tree is multi-level structure, with a root node at the top and multiple levels of internal nodes below it. Only the leaf nodes at the bottom level contains the actual data.</p>
  </li>
  <li>
    <p><strong>Ordered</strong>: B+ Tree is ordered, which makes it easier to perform a search and other operations that require sorted data.</p>
  </li>
  <li>
    <p><strong>Fan-out</strong>: B+ Tree has a high fan-out, which means that each node contains many child nodes. This reduces the height of the tree.</p>
  </li>
</ul>

<h2 id="data-structure"><span class="me-2">Data Structure</span><a href="#data-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>To make it easier to manage the data, binary storage of records will be used and the database files will be stored under <code class="language-plaintext highlighter-rouge">./database</code> with a <code class="language-plaintext highlighter-rouge">.bin</code> extension. Database operations will be disk-based, using a 50th order B+ Tree, a self-balancing multiplexed search tree to store the data.</p>

<p>Define a <code class="language-plaintext highlighter-rouge">key_t</code> to represent the key, initialized to the string <code class="language-plaintext highlighter-rouge">char k[16]</code>, the <code class="language-plaintext highlighter-rouge">keyCmp</code> function is used to compare the size of the two <code class="language-plaintext highlighter-rouge">key_t</code>, overload the operators based on the <code class="language-plaintext highlighter-rouge">keyCmp</code>, and package them into a macro, for more convenient to compare:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="cp">#define OPERATOR_RELOAD (type) 
#define KEYCMP_OPERATOR_RELOAD
</span></pre></td></tr></tbody></table></code></div></div>

<p>Define a <code class="language-plaintext highlighter-rouge">value_t</code> to represent the value, which is <code class="language-plaintext highlighter-rouge">char name[256]</code>, <code class="language-plaintext highlighter-rouge">int value</code> (the integer value entered by the user, which can be age, number, date, etc.) and <code class="language-plaintext highlighter-rouge">char data[256]</code>.</p>

<p>In <code class="language-plaintext highlighter-rouge">include/bplus.h</code>, maintain a <code class="language-plaintext highlighter-rouge">meta_t</code> structure for storing metadata about the database, which will contain: <code class="language-plaintext highlighter-rouge">order</code> (number of orders), <code class="language-plaintext highlighter-rouge">height</code>, <code class="language-plaintext highlighter-rouge">key_size</code>, <code class="language-plaintext highlighter-rouge">value_size</code>, <code class="language-plaintext highlighter-rouge">internal_num</code>, <code class="language-plaintext highlighter-rouge">leaf_num</code>, <code class="language-plaintext highlighter-rouge">root_offset</code>, <code class="language-plaintext highlighter-rouge">leaf_offset</code>, <code class="language-plaintext highlighter-rouge">slot</code> (available slot offset).</p>

<p>Maintains an <code class="language-plaintext highlighter-rouge">index_t</code> structure for storing indexes, containing <code class="language-plaintext highlighter-rouge">key</code> and <code class="language-plaintext highlighter-rouge">child</code>.
Maintains an <code class="language-plaintext highlighter-rouge">internal_t</code> structure for storing internal nodes (all nodes except root and leaves) containing <code class="language-plaintext highlighter-rouge">parent</code> (parent offset), <code class="language-plaintext highlighter-rouge">next</code> (next internal node offset), <code class="language-plaintext highlighter-rouge">prev</code>, <code class="language-plaintext highlighter-rouge">num</code> (number of children), <code class="language-plaintext highlighter-rouge">children[BPLUS_ORDER]</code> (an array of children, of size is the tree order, used to store the index)</p>

<p>Maintains a <code class="language-plaintext highlighter-rouge">leaf_t</code> for storing leaf nodes, containing <code class="language-plaintext highlighter-rouge">parent</code> (parent offset), <code class="language-plaintext highlighter-rouge">next</code> (next node offset), <code class="language-plaintext highlighter-rouge">prev</code>, <code class="language-plaintext highlighter-rouge">num</code> (number of children), <code class="language-plaintext highlighter-rouge">children[BPLUS_ORDER]</code>.</p>

<p>Maintains a <code class="language-plaintext highlighter-rouge">record_t</code> structure for storing records, containing <code class="language-plaintext highlighter-rouge">key</code> and <code class="language-plaintext highlighter-rouge">value</code>.</p>

<h2 id="create-a-b-tree"><span class="me-2">Create a B+ Tree</span><a href="#create-a-b-tree" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="initialization"><span class="me-2">Initialization</span><a href="#initialization" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>
    <p>Init the <code class="language-plaintext highlighter-rouge">meta</code></p>
  </li>
  <li>
    <p>Init root and leaf</p>
  </li>
  <li>
    <p>unmap</p>
  </li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">initEmpty</span><span class="p">(){</span>
    <span class="c1">// init meta</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">meta_t</span><span class="p">));</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">order</span> <span class="o">=</span> <span class="n">BPLUS_ORDER</span><span class="p">;</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">value_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value_t</span><span class="p">);</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">key_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key_t</span><span class="p">);</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">slot</span> <span class="o">=</span> <span class="n">OFFSET_BLOCK</span><span class="p">;</span>
    <span class="c1">// init root node</span>
    <span class="n">internal_t</span> <span class="n">root</span><span class="p">;</span>
    <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">root</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">);</span>
    <span class="c1">// init leaf</span>
    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>
    <span class="n">leaf</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">leaf</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">;</span>
    <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">child</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">);</span>
    <span class="n">meta</span><span class="p">.</span><span class="n">leaf_offset</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">child</span><span class="p">;</span>
    <span class="c1">// unmap to disk</span>
    <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">,</span> <span class="n">OFFSET_META</span><span class="p">);</span>
    <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">);</span>
    <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">child</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="selection"><span class="me-2">Selection</span><a href="#selection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li><strong>Time Complexity</strong>: O(logn)</li>
  <li><strong>Space complexity</strong>: O(1)</li>
</ul>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
</pre></td><td class="rouge-code"><pre><span class="kt">off_t</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">searchIndex</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="kt">off_t</span> <span class="n">index</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">internal_t</span> <span class="n">node</span><span class="p">;</span>
        <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
        <span class="n">index_t</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">;</span>
        <span class="n">height</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">off_t</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">searchLeaf</span><span class="p">(</span><span class="kt">off_t</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="n">internal_t</span> <span class="n">node</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

    <span class="n">index_t</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">searchRange</span><span class="p">(</span><span class="n">key_t</span> <span class="o">*</span><span class="n">left</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">,</span> <span class="n">value_t</span> <span class="o">*</span><span class="n">values</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max</span><span class="p">,</span> <span class="kt">bool</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">right</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">left</span><span class="p">){</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">off_t</span> <span class="n">off_left</span> <span class="o">=</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="o">*</span><span class="n">left</span><span class="p">);</span>
    <span class="kt">off_t</span> <span class="n">off_right</span> <span class="o">=</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
    <span class="kt">off_t</span> <span class="n">off</span> <span class="o">=</span> <span class="n">off_left</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">record_t</span> <span class="o">*</span><span class="n">b_rec</span><span class="p">,</span> <span class="o">*</span><span class="n">e_rec</span><span class="p">;</span>

    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="n">off_right</span> <span class="o">&amp;&amp;</span> <span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">){</span>
        <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">off</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="n">off_left</span> <span class="o">==</span> <span class="n">off</span><span class="p">){</span>
            <span class="n">b_rec</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">*</span><span class="n">left</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">b_rec</span> <span class="o">=</span> <span class="n">begin</span><span class="p">(</span><span class="n">leaf</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">e_rec</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(;</span> <span class="n">b_rec</span> <span class="o">!=</span> <span class="n">e_rec</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">b_rec</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_rec</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">off</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">){</span>
        <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">off_right</span><span class="p">);</span>

        <span class="n">b_rec</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="o">*</span><span class="n">left</span><span class="p">);</span>
        <span class="n">e_rec</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">right</span><span class="p">);</span>
        <span class="k">for</span><span class="p">(;</span> <span class="n">b_rec</span> <span class="o">!=</span> <span class="n">e_rec</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">b_rec</span><span class="o">++</span><span class="p">,</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b_rec</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">max</span> <span class="o">&amp;&amp;</span> <span class="n">b_rec</span> <span class="o">!=</span> <span class="n">e_rec</span><span class="p">){</span>
            <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="n">b_rec</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
    
<span class="kt">int</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">search</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">value_t</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

    <span class="n">record_t</span> <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">record</span> <span class="o">!=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span><span class="p">){</span>
        <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">record</span> <span class="o">-&gt;</span> <span class="n">value</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">keyCmp</span><span class="p">(</span><span class="n">record</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p><strong><em>searchIndex</em></strong> is index traversal function, using the <code class="language-plaintext highlighter-rouge">height</code> get from <code class="language-plaintext highlighter-rouge">meta</code> establish the loop,<code class="language-plaintext highlighter-rouge">map</code> each index searched and with the help of <code class="language-plaintext highlighter-rouge">std::upper_bound</code>, find and return the top of the index (if not found, then return to the end of the sequence and enter the next loop )</p>

<p><strong><em>searchLeaf</em></strong> is a leaf search function, the arguments are the index obtained from <code class="language-plaintext highlighter-rouge">searchIndex</code> and the target key to be selected, 
Map the searched <code class="language-plaintext highlighter-rouge">index</code> to the <code class="language-plaintext highlighter-rouge">node</code>, again using <code class="language-plaintext highlighter-rouge">std::upper_bound</code> to find and return the child of the leaf node.</p>

<blockquote class="prompt-tip">
  <p>In order to simplify the call, overload the function:</p>
</blockquote>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="kt">off_t</span> <span class="nf">searchLeaf</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="k">const</span><span class="p">{</span>
    <span class="k">return</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="n">searchIndex</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In the function <code class="language-plaintext highlighter-rouge">search</code>, call <code class="language-plaintext highlighter-rouge">searchLeaf(key)</code> to find the leaf node where the key of the target record is located, and map to <code class="language-plaintext highlighter-rouge">leaf</code>, through the <code class="language-plaintext highlighter-rouge">std::upper_bound</code> to find the key, we need to judge whether the record searched is not the last, that is, successfully searched for the target record, then take the value of the record and assigned to the memory pointed to by the <code class="language-plaintext highlighter-rouge">value</code> passed into the function, the <code class="language-plaintext highlighter-rouge">search</code> returns the value of <code class="language-plaintext highlighter-rouge">keyCmp(record → key, key)</code>. If the searched <code class="language-plaintext highlighter-rouge">record</code> is the last, that is, did not find the target record, then return -1 to error handling.</p>

<h3 id="insertion"><span class="me-2">Insertion</span><a href="#insertion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li><strong>Time Complexity</strong>: O(logn)</li>
  <li><strong>Space complexity</strong>: O(1)</li>
</ul>

<p>In a B+ Tree, every record is inserted into the bottom level. The insertion will be in increasing order only if there is no overflow.</p>

<p>If there is overflow in leaf node, we should split the node into two nodes, each node contains half of the tree’s order. First node contains <code class="language-plaintext highlighter-rouge">ceil((order-1)/2)</code> values.</p>

<p>If there is overflow in internal nodes, we should also split the node and first node contains <code class="language-plaintext highlighter-rouge">ceil(m/2)-1</code> values.</p>

<p><a href="/assets/img/blog/db/insert.png" class="popup img-link  shimmer"><img src="/assets/img/blog/db/insert.png" alt="insert" loading="lazy"></a></p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">insertRecNoSplit</span><span class="p">(</span><span class="n">leaf_t</span> <span class="o">*</span><span class="n">leaf</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">value_t</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">){</span>
    <span class="n">record_t</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">),</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy_backward</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">end</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="o">*</span><span class="n">leaf</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">where</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">where</span> <span class="o">-&gt;</span> <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">leaf</span> <span class="o">-&gt;</span> <span class="n">num</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">insertKeyNoSplit</span><span class="p">(</span><span class="n">internal_t</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">value</span><span class="p">){</span>
    <span class="n">index_t</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">upper_bound</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy_backward</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">where</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">where</span> <span class="o">-&gt;</span> <span class="n">child</span> <span class="o">=</span> <span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">;</span>
    <span class="p">(</span><span class="n">where</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">insertKey</span><span class="p">(</span><span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">old</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">after</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>  <span class="c1">// create root</span>
        <span class="n">internal_t</span> <span class="n">root</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">root</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span> <span class="o">=</span> <span class="n">alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">);</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">height</span><span class="o">++</span><span class="p">;</span>

        <span class="n">root</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">child</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>
        <span class="n">root</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">child</span> <span class="o">=</span> <span class="n">after</span><span class="p">;</span>

        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">,</span> <span class="n">OFFSET_META</span><span class="p">);</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">root</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">);</span>

        <span class="n">resetParent</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">root</span><span class="p">),</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">internal_t</span> <span class="n">node</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="n">meta</span><span class="p">.</span><span class="n">order</span><span class="p">){</span>   <span class="c1">// full split</span>
        <span class="c1">// find split point</span>
        <span class="kt">size_t</span> <span class="n">point</span> <span class="o">=</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">place_right</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">key</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">place_right</span><span class="p">)</span> <span class="n">point</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">place_right</span> <span class="o">&amp;&amp;</span> <span class="n">key</span> <span class="o">&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">key</span><span class="p">)</span> <span class="n">point</span><span class="o">--</span><span class="p">;</span>

        <span class="n">key_t</span> <span class="n">mid</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">key</span><span class="p">;</span>

        <span class="n">internal_t</span> <span class="n">new_node</span><span class="p">;</span>
        <span class="n">createNode</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_node</span><span class="p">);</span>

        <span class="c1">// split</span>
        <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">+</span> <span class="n">point</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">begin</span><span class="p">(</span><span class="n">new_node</span><span class="p">));</span>
        <span class="n">new_node</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">-</span> <span class="n">point</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">point</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">place_right</span><span class="p">){</span>
            <span class="n">insertKeyNoSplit</span><span class="p">(</span><span class="n">new_node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">after</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">insertKeyNoSplit</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">after</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

        <span class="n">resetParent</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">new_node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">new_node</span><span class="p">),</span> <span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
        <span class="n">insertKey</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">insertKeyNoSplit</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">after</span><span class="p">);</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">insert</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">value_t</span> <span class="n">value</span><span class="p">){</span>
    <span class="kt">off_t</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">searchIndex</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">binary_search</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>   <span class="c1">//find same, return</span>

    <span class="k">if</span><span class="p">(</span><span class="n">leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="n">meta</span><span class="p">.</span><span class="n">order</span><span class="p">){</span>
        <span class="c1">// full, split</span>
        <span class="n">leaf_t</span> <span class="n">new_leaf</span><span class="p">;</span>
        <span class="n">createNode</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_leaf</span><span class="p">);</span>

        <span class="c1">// find split point</span>
        <span class="kt">size_t</span> <span class="n">point</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
        <span class="kt">bool</span> <span class="n">place_right</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="n">point</span><span class="p">].</span><span class="n">key</span> <span class="o">&lt;</span> <span class="n">key</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">place_right</span><span class="p">)</span>
            <span class="n">point</span><span class="o">++</span><span class="p">;</span>

        <span class="c1">// split</span>
        <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">leaf</span><span class="p">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">point</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span><span class="p">,</span> <span class="n">new_leaf</span><span class="p">.</span><span class="n">children</span><span class="p">);</span>
        <span class="n">new_leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">-</span> <span class="n">point</span><span class="p">;</span>
        <span class="n">leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">=</span> <span class="n">point</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="n">place_right</span><span class="p">){</span>
            <span class="n">insertRecNoSplit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">insertRecNoSplit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_leaf</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
        <span class="n">insertKey</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_leaf</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">insertRecNoSplit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div>

<p><strong><em>insertRecNoSplit</em></strong> is used to handle record insertion operations that do not split nodes. This insertion operation searches for the insertion point <code class="language-plaintext highlighter-rouge">where</code> in the target leaf using <code class="language-plaintext highlighter-rouge">std::upper_bound</code>, performs an overwrite operation using <code class="language-plaintext highlighter-rouge">std::copy_backward</code> to shift the node after the insertion point backward to make room for the insertion of the record, and finally updates the number of children and the value, then finally update the number of leaf children.</p>

<p><strong><em>insertKeyNoSplit</em></strong> is used to handle index insertion operation without splitting the node, this insertion operation will search for the index insertion point where in the internal node using <code class="language-plaintext highlighter-rouge">std::upper_bound</code>, use <code class="language-plaintext highlighter-rouge">std::copy_backward</code> to perform an overwrite operation to shift the index after the insertion point backward, to make room for the index, and finally refactor the index and update the children, the children pointed to by <code class="language-plaintext highlighter-rouge">where</code> should be changed to the children of <code class="language-plaintext highlighter-rouge">(where + 1)</code> (i.e., the original children pointed to by the index at that position), and the children of <code class="language-plaintext highlighter-rouge">(where + 1)</code> are the passed <code class="language-plaintext highlighter-rouge">value</code> argument (i.e., the original children pointed to by <code class="language-plaintext highlighter-rouge">(where+1)</code>)</p>

<p><strong><em>insertKey</em></strong> is used to handle key insertion operation, if the <code class="language-plaintext highlighter-rouge">offset</code> is 0, then create the root, if not, then insert operation, insert operation is divided into two kinds of insertion operation, one is directly without splitting insertion, that is, call <code class="language-plaintext highlighter-rouge">insertKeyNoSplit</code> and <code class="language-plaintext highlighter-rouge">unmap</code> to disk, the other when the number of nodes reaches the definition of the number of orders (<code class="language-plaintext highlighter-rouge">meta.order</code>), split: first find the split point, find the evenly split point (<code class="language-plaintext highlighter-rouge">point</code>), then create a new internal node (using the <code class="language-plaintext highlighter-rouge">createNode</code>), use <code class="language-plaintext highlighter-rouge">std::copy</code> to split and update the number of children, after splitting, and then call <code class="language-plaintext highlighter-rouge">insertKeyNoSplit</code> to insert the node (here, use the overloaded operator for the comparison of <code class="language-plaintext highlighter-rouge">key_t</code>), <code class="language-plaintext highlighter-rouge">place_right==true</code> insert the new node, and vice versa insert the old node), <code class="language-plaintext highlighter-rouge">unmap</code> to disk, and finally need to call <code class="language-plaintext highlighter-rouge">resetParent</code> and <code class="language-plaintext highlighter-rouge">insertKey</code> to adjust the parent node, to complete the insertion and the data structure rebalance operation.</p>

<p><strong><em>insert</em></strong> is used to deal with the insertion of records, first through the <code class="language-plaintext highlighter-rouge">search</code> method to locate the insertion point and the parent offset. Map <code class="language-plaintext highlighter-rouge">offset</code> to <code class="language-plaintext highlighter-rouge">leaf</code>, a run <code class="language-plaintext highlighter-rouge">binary_search</code>, if the same record is found, return -1, otherwise perform the insertion operation. Insertion operation is divided into two cases, if the number of records does not reach the order, that is, do not need to split, insert with the <code class="language-plaintext highlighter-rouge">insertRecNoSplit</code> and <code class="language-plaintext highlighter-rouge">unmap</code> to disk; if the number of records to reach the order,  need to split: <code class="language-plaintext highlighter-rouge">createNode</code> to create a new node, simple calculation to get the <code class="language-plaintext highlighter-rouge">point</code>, determine whether <code class="language-plaintext highlighter-rouge">place_right</code>, finally, start splitting. Use <code class="language-plaintext highlighter-rouge">std::copy</code> to split and update the children information, and <code class="language-plaintext highlighter-rouge">insertRecNoSplit</code> to insert and <code class="language-plaintext highlighter-rouge">unmap</code> to disk. Eventually, <code class="language-plaintext highlighter-rouge">insertKey</code> is used to insert the new leaf into the parent, further updating the parents to maintain a balanced structure.</p>

<h3 id="deletion"><span class="me-2">Deletion</span><a href="#deletion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li><strong>Time Complexity</strong>: O(logn)</li>
  <li><strong>Space complexity</strong>: O(1)</li>
</ul>

<p>Deleting an element on a B+ tree consists of three main events: searching the node, deleting the key and balancing the tree if required.</p>

<p>Underflow is a situation when there is less number of keys in a node than the minimum number of keys it should hold.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">removeNode</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">prev</span><span class="p">,</span> <span class="n">T</span> <span class="o">*</span><span class="n">node</span><span class="p">){</span>
    <span class="n">unalloc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">prev</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">);</span>
    <span class="n">prev</span> <span class="o">-&gt;</span> <span class="n">next</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">T</span> <span class="n">next</span><span class="p">;</span>
        <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">,</span> <span class="n">SIZE_NO_CHILDREN</span><span class="p">);</span>
        <span class="n">next</span><span class="p">.</span><span class="n">prev</span> <span class="o">=</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">prev</span><span class="p">;</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">node</span> <span class="o">-&gt;</span> <span class="n">next</span><span class="p">,</span> <span class="n">SIZE_NO_CHILDREN</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">,</span> <span class="n">OFFSET_META</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">removeIndex</span><span class="p">(</span><span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">internal_t</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">min</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span> <span class="o">==</span> <span class="n">offset</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">meta</span><span class="p">.</span><span class="n">order</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">key_t</span> <span class="n">index_key</span> <span class="o">=</span> <span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">index_t</span> <span class="o">*</span><span class="n">to_delete</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">to_delete</span> <span class="o">!=</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">)){</span>
        <span class="p">(</span><span class="n">to_delete</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">child</span> <span class="o">=</span> <span class="n">to_delete</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">to_delete</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">to_delete</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">node</span><span class="p">.</span><span class="n">num</span><span class="o">--</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span> <span class="o">==</span> <span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="p">.</span><span class="n">internal_num</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">){</span>
        <span class="n">unalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span><span class="p">);</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">height</span><span class="o">--</span><span class="p">;</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">root_offset</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">child</span><span class="p">;</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">meta</span><span class="p">,</span> <span class="n">OFFSET_META</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>   <span class="c1">// delete root, decrease height, reset root</span>

    <span class="k">if</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">){</span>
        <span class="n">internal_t</span> <span class="n">parent</span><span class="p">;</span>
        <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">borrowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="n">begin</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">)</span>
            <span class="n">borrowed</span> <span class="o">=</span> <span class="n">borrowKey</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">borrowed</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">!=</span> <span class="p">(</span><span class="n">end</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">)</span>
            <span class="n">borrowed</span> <span class="o">=</span> <span class="n">borrowKey</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">borrowed</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="p">(</span><span class="n">end</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">child</span><span class="p">){</span>
                <span class="n">internal_t</span> <span class="n">prev</span><span class="p">;</span>
                <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>

                <span class="n">index_t</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">begin</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="p">);</span>
                <span class="n">resetParent</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">node</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
                <span class="n">mergeKey</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">prev</span><span class="p">,</span> <span class="n">node</span><span class="p">);</span>
                <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">internal_t</span> <span class="n">next</span><span class="p">;</span>
                <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

                <span class="n">index_t</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">index_key</span><span class="p">);</span>
                <span class="n">resetParent</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">next</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">next</span><span class="p">),</span> <span class="n">offset</span><span class="p">);</span>
                <span class="n">mergeKey</span><span class="p">(</span><span class="n">where</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
                <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">removeIndex</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index_key</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">node</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">remove</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">){</span>
    <span class="n">internal_t</span> <span class="n">parent</span><span class="p">;</span>
    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>

    <span class="kt">off_t</span> <span class="n">parent_off</span> <span class="o">=</span> <span class="n">searchIndex</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span> <span class="n">parent_off</span><span class="p">);</span>

    <span class="n">index_t</span> <span class="o">*</span><span class="n">where</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">where</span> <span class="o">-&gt;</span> <span class="n">child</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">binary_search</span><span class="p">(</span><span class="n">begin</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">key</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">// cannot find</span>

    <span class="kt">size_t</span> <span class="n">min</span> <span class="o">=</span> <span class="n">meta</span><span class="p">.</span><span class="n">leaf_num</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">meta</span><span class="p">.</span><span class="n">order</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">record_t</span> <span class="o">*</span><span class="n">to_delete</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">to_delete</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">(</span><span class="n">leaf</span><span class="p">),</span> <span class="n">to_delete</span><span class="p">);</span>
    <span class="n">leaf</span><span class="p">.</span><span class="n">num</span><span class="o">--</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="n">leaf</span><span class="p">.</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">){</span>
        <span class="kt">bool</span> <span class="n">borrowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">leaf</span><span class="p">.</span><span class="n">prev</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">borrowed</span> <span class="o">=</span> <span class="n">borrowKey</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="n">leaf</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">borrowed</span> <span class="o">&amp;&amp;</span> <span class="n">leaf</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">borrowed</span> <span class="o">=</span> <span class="n">borrowKey</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span> <span class="n">leaf</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">borrowed</span><span class="p">){</span>
            <span class="n">key_t</span> <span class="n">index_key</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">where</span> <span class="o">==</span> <span class="n">end</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">){</span>
                <span class="n">leaf_t</span> <span class="n">prev</span><span class="p">;</span>
                <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
                <span class="n">index_key</span> <span class="o">=</span> <span class="n">begin</span><span class="p">(</span><span class="n">prev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>

                <span class="n">mergeLeaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf</span><span class="p">);</span>
                <span class="n">removeNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leaf</span><span class="p">);</span>
                <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prev</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
            <span class="p">}</span><span class="k">else</span><span class="p">{</span>
                <span class="n">leaf_t</span> <span class="n">next</span><span class="p">;</span>
                <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="n">leaf</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
                <span class="n">index_key</span> <span class="o">=</span> <span class="n">begin</span><span class="p">(</span><span class="n">leaf</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>

                <span class="n">mergeLeaf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">);</span>
                <span class="n">removeNode</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">);</span>
                <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="n">removeIndex</span><span class="p">(</span><span class="n">parent_off</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">index_key</span><span class="p">);</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
    
</pre></td></tr></tbody></table></code></div></div>

<p><strong><em>removeNode</em></strong> is simple, <code class="language-plaintext highlighter-rouge">unalloc</code> the node (update the meta), transfer the successor of the deleted node to the predecessor, if the deleted node is not the last node, map the successor of the node, transfer the predecessor of the node to its predecessor and unmap it to disk, and finally unmap the meta, the whole operation is actually a linear table operation.</p>

<p><strong><em>removeIndex</em></strong> is used to remove the index, <code class="language-plaintext highlighter-rouge">min</code> is used as the minimum number of nodes, if it is not the root, min is half of the order. <code class="language-plaintext highlighter-rouge">to_delete</code> is the index for deletion, use <code class="language-plaintext highlighter-rouge">find</code> to locate it, if <code class="language-plaintext highlighter-rouge">to_delete</code> is not the last index, transfer his children to the latter index and overwrite it with <code class="language-plaintext highlighter-rouge">std::copy</code>, if <code class="language-plaintext highlighter-rouge">to_delete</code> is the root and there is only one node, then delete it directly and update <code class="language-plaintext highlighter-rouge">root_offset</code> to reduce the tree height to balance the tree structure. If the number of children of the node where <code class="language-plaintext highlighter-rouge">to_delete</code> is located is less than <code class="language-plaintext highlighter-rouge">min</code>, it is necessary to borrow and merge. Record the father parent, the state of whether <code class="language-plaintext highlighter-rouge">borrowed</code> (a boolean), if the offset is the first child of the father, borrow from the left node, and vice versa from the right node, borrowing node are implemented using <code class="language-plaintext highlighter-rouge">borrowKey</code>, which uses two sets of overloading to deal with leaf and internal nodes, for leaf: <code class="language-plaintext highlighter-rouge">lender_off</code> through the incoming boolean value <code class="language-plaintext highlighter-rouge">from_right</code> to determine the lender offset, with the help of this offset map it to the <code class="language-plaintext highlighter-rouge">lender</code>, if the lender’s children did not reach the half of the order, merge the beginning of the lender to the end of the borrower, or merge the end of the lender to the beginning of the borrower, use <code class="language-plaintext highlighter-rouge">changeParent</code> to change the parent after splicing data with <code class="language-plaintext highlighter-rouge">std::copy_backward</code>, update the children, and finally applied to disk; for internal node is much the same, just one more step, change the node pointing. After completing the borrow operation, map the node’s predecessor or successor to <code class="language-plaintext highlighter-rouge">prev</code>/<code class="language-plaintext highlighter-rouge">next</code>, use <code class="language-plaintext highlighter-rouge">mergeKey</code> to merge the keys, in <code class="language-plaintext highlighter-rouge">mergeKey</code>, use <code class="language-plaintext highlighter-rouge">std::copy</code> to splice the left and right, update the children, and use <code class="language-plaintext highlighter-rouge">removeNode</code> to remove nodes that are discarded after the merge.</p>

<p><strong><em>remove</em></strong> performs delete operation, use <code class="language-plaintext highlighter-rouge">searchIndex</code> and <code class="language-plaintext highlighter-rouge">find</code> to get and map parent with leaf, return -1 if the key is not found in leaf (use <code class="language-plaintext highlighter-rouge">binary_search</code>), determine the minimum number of nodes <code class="language-plaintext highlighter-rouge">min</code>, with delete point <code class="language-plaintext highlighter-rouge">to_delete</code>, use <code class="language-plaintext highlighter-rouge">std::copy</code> to override, if the number of leaf is less than the minimum number of nodes, set <code class="language-plaintext highlighter-rouge">borrowed</code> to indicate the state of borrowing. We need to set three judgments, if the leaf precursor is not 0, borrow from the left, if the successor is not 0, borrow from the right, after the borrowing and lending of left/right, it is still unborrowed state, the leaf precursor will be mapped to <code class="language-plaintext highlighter-rouge">prev</code>. Record the key, merge the leaf and the precursor into one node, delete the leaf, complete the right-merge operation. Otherwise perform the left-merge operation, after the merge operation, of course, unmap to disk. Completion of leaf deletion, need to delete in the index, call <code class="language-plaintext highlighter-rouge">removeIndex(parent_off, parent, index_key)</code> to realize the deletion.</p>

<h3 id="update"><span class="me-2">Update</span><a href="#update" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">BPlusTree</span><span class="o">::</span><span class="n">update</span><span class="p">(</span><span class="k">const</span> <span class="n">key_t</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">value_t</span> <span class="n">value</span><span class="p">){</span>
    <span class="kt">off_t</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">searchLeaf</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="n">leaf_t</span> <span class="n">leaf</span><span class="p">;</span>
    <span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

    <span class="n">record_t</span> <span class="o">*</span><span class="n">record</span> <span class="o">=</span> <span class="n">find</span><span class="p">(</span><span class="n">leaf</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">record</span> <span class="o">!=</span> <span class="n">leaf</span><span class="p">.</span><span class="n">children</span> <span class="o">+</span> <span class="n">leaf</span><span class="p">.</span><span class="n">num</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="n">record</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="p">){</span>
            <span class="n">record</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
            <span class="n">unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leaf</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>  <span class="c1">// not found</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The update algorithm is implemented using <code class="language-plaintext highlighter-rouge">update(const key_t&amp; key, value_t value)</code>, using <code class="language-plaintext highlighter-rouge">searchLeaf</code> to find the target offset and map it, if not found then return -1, otherwise determine whether the found record key matches the provided one, (because the essence of <code class="language-plaintext highlighter-rouge">find</code> is implemented as <code class="language-plaintext highlighter-rouge">std::lower_bound</code>. find the key may be the first key greater than the target rather than the one we need to be exactly equal to the target, so a futher judgment is necessary), match then update the <code class="language-plaintext highlighter-rouge">value</code> of the record, umap and return 0, does not match then return 1 error.</p>

<ul>
  <li><strong>Time Complexity</strong>: O(logn)</li>
  <li><strong>Space complexity</strong>: O(1)</li>
</ul>

<h2 id="interface"><span class="me-2">Interface</span><a href="#interface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>For better management, design a shell-like user interface. Define to handler for commands handling.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">using</span> <span class="n">CommandHandler</span> <span class="o">=</span> <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">using</span> <span class="n">OptionHandler</span> <span class="o">=</span> <span class="kt">void</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="k">const</span> <span class="n">string</span><span class="o">&amp;</span> <span class="n">arg</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Use two <code class="language-plaintext highlighter-rouge">map</code> and lambda funtion to store correspondence of commands and handlers.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">OptionHandler</span><span class="o">&gt;</span> <span class="n">optionMap</span> <span class="o">=</span> <span class="p">{........};</span>
<span class="n">map</span><span class="o">&lt;</span><span class="n">string</span><span class="p">,</span> <span class="n">CommandHandler</span><span class="o">&gt;</span> <span class="n">commandMap</span> <span class="o">=</span> <span class="p">{........};</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After launching the program, it will firstly enter the <code class="language-plaintext highlighter-rouge">optionLoop</code> for database management:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>help                                         show help menu
exit                                           exit console
clear                                          clear screen
list                                list available database
new {name}                            create a new database
use {name}                                login to database
reset {name}                                 reset database
drop {name}                                   drop database
</pre></td></tr></tbody></table></code></div></div>

<p>Use <code class="language-plaintext highlighter-rouge">use</code> command to login the database and enter the second <code class="language-plaintext highlighter-rouge">commandLoop</code> for data management:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre> help                                        show help menu
 exit                                         exit database
 select id {id}                             search by index
 select in {b},{e}                 search in range of (b,e)
 insert {id} {name} {value} {data}          insert a record
 update {id} {name} {value} {data}          update a record
 delete id {id}                                delete by id
</pre></td></tr></tbody></table></code></div></div>

<h2 id="compile-and-test"><span class="me-2">Compile and Test</span><a href="#compile-and-test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="platform"><span class="me-2">Platform:</span><a href="#platform" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<ul>
  <li>
    <p>Linux 6.11.2-amd64 #1 SMP PREEMPT_DYNAMIC x86_64 GNU/Linux</p>
  </li>
  <li>
    <p>gcc version 14.2.0 (Debian 14.2.0-8)</p>
  </li>
</ul>

<h3 id="make-and-run"><span class="me-2">Make and Run</span><a href="#make-and-run" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We could have a <strong><em>Makefile</em></strong> to compile the whole source:</p>

<div class="language-makefile highlighter-rouge"><div class="code-header">
        <span data-label-text="Makefile"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nv">CXX</span> <span class="o">=</span> g++

<span class="nv">SRC_DIR</span> <span class="o">=</span> ./
<span class="nv">TARGET</span> <span class="o">=</span> easydb
<span class="nv">OBJ</span> <span class="o">=</span> main.o bplus.o

<span class="nl">$(TARGET)</span><span class="o">:</span><span class="nf">$(OBJ)</span>
	<span class="p">$(</span>CXX<span class="p">)</span> <span class="nt">-o</span> <span class="p">$(</span>TARGET<span class="p">)</span> <span class="p">$(</span>OBJ<span class="p">)</span>
	<span class="nb">rm</span> <span class="nt">-rf</span> <span class="p">$(</span>OBJ<span class="p">)</span>

<span class="nl">main.o</span><span class="o">:</span>
	<span class="p">$(</span>CXX<span class="p">)</span> <span class="nt">-c</span> <span class="p">$(</span>SRC_DIR<span class="p">)</span>main.cpp

<span class="nl">bplus.o</span><span class="o">:</span>
	<span class="p">$(</span>CXX<span class="p">)</span> <span class="nt">-c</span> <span class="p">$(</span>SRC_DIR<span class="p">)</span>bplus.cpp

<span class="nl">clean</span><span class="o">:</span>
	<span class="nb">rm</span> <span class="nt">-rf</span> <span class="p">$(</span>OBJ<span class="p">)</span> <span class="p">$(</span>TARGET<span class="p">)</span>

</pre></td></tr></tbody></table></code></div></div>

<blockquote class="prompt-tip">
  <p><strong><em>CMake</em></strong> is another option easy to use:</p>
</blockquote>

<div class="language-cmake highlighter-rouge"><div class="code-header">
        <span data-label-text="Cmake"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.10<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>easydb<span class="p">)</span>

<span class="nb">add_executable</span><span class="p">(</span>easydb main.cpp bplus.cpp<span class="p">)</span>

<span class="nb">include_directories</span><span class="p">(</span><span class="si">${</span><span class="nv">PROJECT_SOURCE_DIR</span><span class="si">}</span>/include<span class="p">)</span>

<span class="nb">add_compile_options</span><span class="p">(</span>-fexec-charset=UTF-8<span class="p">)</span>
<span class="nb">add_compile_options</span><span class="p">(</span>-finput-charset=GBK<span class="p">)</span>
<span class="nb">add_compile_options</span><span class="p">(</span>-fwide-exec-charset=UTF-8<span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>To build the program, just simply use <code class="language-plaintext highlighter-rouge">make</code>. The target output will be <code class="language-plaintext highlighter-rouge">./easydb</code>.</p>

<p><a href="/assets/img/blog/db/interface.png" class="popup img-link  shimmer"><img src="/assets/img/blog/db/interface.png" alt="interface" loading="lazy"></a></p>

<h3 id="test"><span class="me-2">Test</span><a href="#test" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>We can write a simple test script with shell or python to test the program, here’s an example in C++ running on Linux:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fstream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;thread&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">num_inserts</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pipe_name</span> <span class="o">=</span> <span class="s">"pipe"</span><span class="p">;</span>

    <span class="n">mkfifo</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">,</span><span class="mo">0666</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">ofstream</span> <span class="n">logFile</span><span class="p">(</span><span class="s">"time.log"</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">streambuf</span> <span class="o">*</span><span class="n">coutbuf</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">(</span><span class="n">logFile</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">());</span>


    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="n">easydb_thread</span><span class="p">([</span><span class="n">pipe_name</span><span class="p">]()</span> <span class="p">{</span>
        <span class="n">std</span><span class="o">::</span><span class="n">system</span><span class="p">(</span><span class="s">"./easydb &lt; pipe &amp;"</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">,</span> <span class="n">O_WRONLY</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">start_duration</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">.</span><span class="n">time_since_epoch</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">milliseconds</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">start_duration</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">&lt;&lt;</span> <span class="n">milliseconds</span> <span class="o">&lt;&lt;</span> <span class="s">"]: "</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Start insert test"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">command</span><span class="p">;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">"use db</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">command</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
    <span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">num_inserts</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">"insert "</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">" name"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">" "</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">" item"</span> <span class="o">+</span> <span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s">"@data</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
        <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">command</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">"exit</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">command</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>
    <span class="n">command</span> <span class="o">=</span> <span class="s">"exit</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">command</span><span class="p">.</span><span class="n">length</span><span class="p">());</span>

    <span class="k">auto</span> <span class="n">end_time</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">);</span>

    <span class="k">auto</span> <span class="n">stop_duration</span> <span class="o">=</span> <span class="n">end_time</span><span class="p">.</span><span class="n">time_since_epoch</span><span class="p">();</span>
    <span class="n">milliseconds</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stop_duration</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"["</span> <span class="o">&lt;&lt;</span> <span class="n">milliseconds</span> <span class="o">&lt;&lt;</span> <span class="s">"]: "</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Insert "</span> <span class="o">&lt;&lt;</span> <span class="n">num_inserts</span> <span class="o">&lt;&lt;</span> <span class="s">" records, time: "</span> <span class="o">&lt;&lt;</span> <span class="n">elapsed_time</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" s"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="n">easydb_thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
    <span class="n">unlink</span><span class="p">(</span><span class="n">pipe_name</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">.</span><span class="n">rdbuf</span><span class="p">(</span><span class="n">coutbuf</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The test program will open a pipe then insert 100000 records to the database <code class="language-plaintext highlighter-rouge">db</code>, it records the duration time and write to the log <code class="language-plaintext highlighter-rouge">time.log</code>. Build the test program with <code class="language-plaintext highlighter-rouge">g++</code>:</p>

<div class="language-shell highlighter-rouge"><div class="code-header">
        <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>g++ test_insert.cpp <span class="nt">-o</span> <span class="nb">test</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In the log file <em>time.log</em>, for example:</p>

<div class="language-plaintext highlighter-rouge"><div class="code-header">
        <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>[timexxxxxxxxxx]: Start insert test
[timexxxxxxxxxx]: Insert 100000 records, time: 4 s
</pre></td></tr></tbody></table></code></div></div>

<p><a href="/assets/img/blog/db/test.png" class="popup img-link  shimmer"><img src="/assets/img/blog/db/test.png" alt="test" loading="lazy"></a></p>

<h2 id="source-code"><span class="me-2">Source Code</span><a href="#source-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Github: <a href="https://github.com/the0cp/db">https://github.com/the0cp/db</a></p>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    

    <!-- tags -->
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=B+%20Tree%20Database%20in%20Modern%20C++%20-%20Blog%20%7C%20the0cp&url=https%3A%2F%2Fthe0cp.github.io%2Fposts%2Fdatabase%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=B+%20Tree%20Database%20in%20Modern%20C++%20-%20Blog%20%7C%20the0cp&u=https%3A%2F%2Fthe0cp.github.io%2Fposts%2Fdatabase%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Fthe0cp.github.io%2Fposts%2Fdatabase%2F&text=B+%20Tree%20Database%20in%20Modern%20C++%20-%20Blog%20%7C%20the0cp" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fthe0cp.github.io%2Fposts%2Fdatabase%2F&title=B+%20Tree%20Database%20in%20Modern%20C++%20-%20Blog%20%7C%20the0cp" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit">
        <i class="fa-fw fa-brands fa-square-reddit"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/database/">B+ Tree Database in Modern C++</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/dell/">Open-source Thermal Control for Dell G-series</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/ace/">Auto Objection! Android Ace Attorney Simulator</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/aseprite/">Automatically build Aseprite with Github Actions</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/vserial/">Create Virtual Serial Port in Linux</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pentest/">Pentest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">C/C++</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/qt/">Qt</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/beautify/">Beautify</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blogging/">Blogging</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/github/">Github</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hexo/">Hexo</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">Python</a>
      
    </div>
  </section>


            </div>

            
              
              






  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->


























            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/dell/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>Open-source Thermal Control for Dell G-series</p>
    </a>
  

  
    <div class="btn btn-outline-primary disabled" aria-label="Newer">
      <p>-</p>
    </div>
  
</nav>

            
              
              <!-- The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2024</time>

    
      <!--<a href="https://twitter.com/T_Ccooper">Theodore Cooper</a>.-->
      Theodore Cooper.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >
      <!--All rights reserved.-->
      </span>
    
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pentest/">Pentest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">C/C++</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/qt/">Qt</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/beautify/">Beautify</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blogging/">Blogging</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/github/">Github</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hexo/">Hexo</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/python/">Python</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script>







<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  







    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

