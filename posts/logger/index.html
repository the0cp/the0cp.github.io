<!doctype html>














<!-- `site.alt_lang` can specify a language different from the UI -->
<html lang="en" data-mode="dark">
  <head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta
    name="viewport"
    content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover"
  >


  <!-- Global site tag (gtag.js) - Google Analytics -->
<script defer src="https://www.googletagmanager.com/gtag/js?id=G-SLEGY5RRPL"></script>
<script>
  document.addEventListener('DOMContentLoaded', function (event) {
    window.dataLayer = window.dataLayer || [];
    function gtag() {
      dataLayer.push(arguments);
    }

    gtag('js', new Date());
    gtag('config', 'G-SLEGY5RRPL');
  });
</script>
<!-- Setup Open Graph image -->

  

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Simple Thread-safe Logger in C++" />
<meta name="author" content="Theodore Cooper" />
<meta property="og:locale" content="en" />
<meta name="description" content="A very simple, small, thread-safe and stream-styled logger written in C++." />
<meta property="og:description" content="A very simple, small, thread-safe and stream-styled logger written in C++." />
<link rel="canonical" href="https://the0cp.cc/posts/logger/" />
<meta property="og:url" content="https://the0cp.cc/posts/logger/" />
<meta property="og:site_name" content="Blog - the0cp" />
<meta property="og:image" content="https://the0cp.cc/assets/img/blog/logger/logger.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-12-26T00:00:00+09:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://the0cp.cc/assets/img/blog/logger/logger.jpg" />
<meta property="twitter:title" content="Simple Thread-safe Logger in C++" />
<meta name="twitter:site" content="@T_Ccooper" />
<meta name="twitter:creator" content="@T_Ccooper" />
<meta name="yandex-verification" content="41dbd09c93221b0e" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Theodore Cooper","url":"https://github.com/the0cp/"},"dateModified":"2024-12-26T00:00:00+09:00","datePublished":"2024-12-26T00:00:00+09:00","description":"A very simple, small, thread-safe and stream-styled logger written in C++.","headline":"Simple Thread-safe Logger in C++","image":{"lqip":"/assets/img/placeholder.webp","url":"https://the0cp.cc/assets/img/blog/logger/logger.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://the0cp.cc/posts/logger/"},"url":"https://the0cp.cc/posts/logger/"}</script>
<!-- End Jekyll SEO tag -->


  <title>Simple Thread-safe Logger in C++ | Blog - the0cp
  </title>

  <!--
  The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps
  Generated by: https://realfavicongenerator.net/
-->



<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">

  <link rel="manifest" href="/assets/img/favicons/site.webmanifest">

<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="Blog - the0cp">
<meta name="application-name" content="Blog - the0cp">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">


  <!-- Resource Hints -->
  
    
      
        <link rel="preconnect" href="https://fonts.googleapis.com" >
      
        <link rel="dns-prefetch" href="https://fonts.googleapis.com" >
      
    
      
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      
        <link rel="dns-prefetch" href="https://fonts.gstatic.com" >
      
    
      
        <link rel="preconnect" href="https://cdn.jsdelivr.net" >
      
        <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" >
      
    
  

  <!-- Bootstrap -->
  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  

  <!-- Theme style -->
  <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">

  <!-- Web Font -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap">

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css">

  <!-- 3rd-party Dependencies -->

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.29.0/dist/tocbot.min.css">
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
  

  
    <!-- Image Popup -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css">
  

  <!-- JavaScript -->

  

  <!-- A placeholder to allow defining custom metadata -->

</head>


  <body>
    <!-- The Side Bar -->

<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end">
  <header class="profile-wrapper">
    <a href="/" id="avatar" class="rounded-circle"><img src="/avatar.jpg" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a>

    <a class="site-title d-block" href="/">Blog - the0cp</a>
    <p class="site-subtitle fst-italic mb-0">Talk is cheap, show me the code.</p>
  </header>
  <!-- .profile-wrapper -->

  <nav class="flex-column flex-grow-1 w-100 ps-0">
    <ul class="nav">
      <!-- home -->
      <li class="nav-item">
        <a href="/" class="nav-link">
          <i class="fa-fw fas fa-home"></i>
          <span>HOME</span>
        </a>
      </li>
      <!-- the real tabs -->
      
        <li class="nav-item">
          <a href="/categories/" class="nav-link">
            <i class="fa-fw fas fa-stream"></i>
            

            <span>CATEGORIES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/tags/" class="nav-link">
            <i class="fa-fw fas fa-tags"></i>
            

            <span>TAGS</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/archives/" class="nav-link">
            <i class="fa-fw fas fa-archive"></i>
            

            <span>ARCHIVES</span>
          </a>
        </li>
        <!-- .nav-item -->
      
        <li class="nav-item">
          <a href="/about/" class="nav-link">
            <i class="fa-fw fas fa-info-circle"></i>
            

            <span>ABOUT</span>
          </a>
        </li>
        <!-- .nav-item -->
      
    </ul>
  </nav>

  <div class="sidebar-bottom d-flex flex-wrap  align-items-center w-100">
    

    
      

      
        <a
          href="https://github.com/the0cp"
          aria-label="github"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fab fa-github"></i>
        </a>
      
    
      

      
        <a
          href="https://twitter.com/T_Ccooper"
          aria-label="twitter"
          

          
            target="_blank"
            
          

          

          
            rel="noopener noreferrer"
          
        >
          <i class="fa-brands fa-x-twitter"></i>
        </a>
      
    
      

      
        <a
          href="javascript:location.href = 'mailto:' + ['ccooperr2005','gmail.com'].join('@')"
          aria-label="email"
          

          

          

          
        >
          <i class="fas fa-envelope"></i>
        </a>
      
    
      

      
        <a
          href="/feed.xml"
          aria-label="rss"
          

          

          

          
        >
          <i class="fas fa-rss"></i>
        </a>
      
    
  </div>
  <!-- .sidebar-bottom -->
</aside>
<!-- #sidebar -->


    <div id="main-wrapper" class="d-flex justify-content-center">
      <div class="container d-flex flex-column px-xxl-5">
        <!-- The Top Bar -->

<header id="topbar-wrapper" aria-label="Top Bar">
  <div
    id="topbar"
    class="d-flex align-items-center justify-content-between px-lg-3 h-100"
  >
    <nav id="breadcrumb" aria-label="Breadcrumb">
      

      
        
          
            <span>
              <a href="/">Home</a>
            </span>

          
        
          
        
          
            
              <span>Simple Thread-safe Logger in C++</span>
            

          
        
      
    </nav>
    <!-- endof #breadcrumb -->

    <button type="button" id="sidebar-trigger" class="btn btn-link">
      <i class="fas fa-bars fa-fw"></i>
    </button>

    <div id="topbar-title">
      Post
    </div>

    <button type="button" id="search-trigger" class="btn btn-link">
      <i class="fas fa-search fa-fw"></i>
    </button>

    <search id="search" class="align-items-center ms-3 ms-lg-0">
      <i class="fas fa-search fa-fw"></i>
      <input
        class="form-control"
        id="search-input"
        type="search"
        aria-label="search"
        autocomplete="off"
        placeholder="Search..."
      >
    </search>
    <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
  </div>
</header>


        <div class="row flex-grow-1">
          <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              <!-- Refactor the HTML structure -->



<!--
  In order to allow a wide table to scroll horizontally,
  we suround the markdown table with `<div class="table-wrapper">` and `</div>`
-->



<!--
  Fixed kramdown code highlight rendering:
  https://github.com/penibelst/jekyll-compress-html/issues/101
  https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901
-->



<!-- Change the icon of checkbox -->



<!-- Handle images -->




  
  

  
    
      
      
    

    
    

    

    
    

    
    
    

    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    
      

      
      
      

      
    

    <!-- take out classes -->
    

    
    

    

    
      
      

      

      <!-- add image placeholder -->
      

    

    <!-- lazy-load images -->
    

    
      <!-- make sure the `<img>` is wrapped by `<a>` -->
      

      
        <!-- create the image wrapper -->
        

        
        
      
    

    <!-- combine -->
    
  

  


<!-- Add header for code snippets -->



<!-- Create heading anchors -->





  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  
    
    

    
      
        
        
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    
      

      
      

      
      
      

      
    

    
  

  
  

  




<!-- return -->










<article class="px-1" data-toc="true">
  <header>
    <h1 data-toc-skip>Simple Thread-safe Logger in C++</h1>
    
      <p class="post-desc fw-light mb-4">A very simple, small, thread-safe and stream-styled logger written in C++.</p>
    

    <div class="post-meta text-muted">
      <!-- published date -->
      <span>
        Posted
        <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1735138800"
  data-df="ll"
  
    data-bs-toggle="tooltip" data-bs-placement="bottom"
  
>
  Dec 26, 2024
</time>

      </span>

      <!-- lastmod date -->
      

      
        
        
        

        

        <div class="mt-3 mb-3">
          <a href="/assets/img/blog/logger/logger.jpg" class="popup img-link preview-img blur"><img data-src="/assets/img/blog/logger/logger.jpg"  alt="Preview Image" width="1200" height="630" data-lqip="true" src="/assets/img/placeholder.webp"></a></div>
      

      <div class="d-flex justify-content-between">
        <!-- author(s) -->
        <span>
          

          By

          <em>
            
              
                <a href="https://github.com/the0cp/">Theodore Cooper</a>
                
              
            
          </em>
        </span>

        <div>
          <!-- pageviews -->
          

          <!-- read time -->
          <!-- Calculate the post's reading time, and display the word count in tooltip -->



<!-- words per minute -->










<!-- return element -->
<span
  class="readtime"
  data-bs-toggle="tooltip"
  data-bs-placement="bottom"
  title="4572 words"
>
  <em>25 min</em> read</span>

        </div>
      </div>
    </div>
  </header>

  
    <div id="toc-bar" class="d-flex align-items-center justify-content-between invisible">
      <span class="label text-truncate">Simple Thread-safe Logger in C++</span>
      <button type="button" class="toc-trigger btn me-1">
        <i class="fa-solid fa-list-ul fa-fw"></i>
      </button>
    </div>

    <button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm">
      <span class="label ps-2 pe-1">Contents</span>
      <i class="fa-solid fa-angle-right fa-fw"></i>
    </button>

    <dialog id="toc-popup" class="p-0">
      <div class="header d-flex flex-row align-items-center justify-content-between">
        <div class="label text-truncate py-2 ms-4">Simple Thread-safe Logger in C++</div>
        <button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75">
          <i class="fas fa-close"></i>
        </button>
      </div>
      <div id="toc-popup-content" class="px-4 py-3 pb-4"></div>
    </dialog>
  

  <div class="content">
    <p>A thread-safe logger is crucial for the correct functioning and maintainability of multi-threaded applications. It ensures data integrity, prevents race conditions, and provides reliable log records for debugging and troubleshooting. Without the thread safety, multiple threads can attempt to log message simultaneously which can lead to interleaved messages and data corruption.</p>

<h2 id="thread-safety"><span class="me-2">Thread Safety</span><a href="#thread-safety" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>The <code class="language-plaintext highlighter-rouge">std::atomic&lt;T&gt;</code> provides an atomic type that different threads can simultaneously operate on without raising undefined behavior.</p>

<p>Also, <code class="language-plaintext highlighter-rouge">std::atomic&lt;T&gt;</code> gives you more control by allowing various <em>memory orders</em> that specify synchronization and ordering constraints.</p>

<h3 id="simple-multi-threaded-data-access"><span class="me-2">Simple multi-threaded data access</span><a href="#simple-multi-threaded-data-access" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>In a multi-threaded scenario, we have <code class="language-plaintext highlighter-rouge">int A=B=0;</code>.</p>

<p>In thread-1:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In thread-2:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="execute-in-sequence"><span class="me-2">Execute in sequence</span><a href="#execute-in-sequence" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>The simplest case is the two threads execute in sequence, that is, after one thread completes execution, the instructions of the other thread are executed. In this case, there are two possibilities:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The output will be: 01</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
<span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The output will be: 02</p>

<h4 id="execute-alternately"><span class="me-2">Execute alternately</span><a href="#execute-alternately" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In this case, it will print 12</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The output will be 21</p>

<h4 id="print-00"><span class="me-2">print 00</span><a href="#print-00" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>In addition to the above cases, there is another possibility of printing 00, but this kind of output is unlikely to occur under normal circumstances.</p>

<h4 id="happen-before-rule"><span class="me-2">Happen-before Rule</span><a href="#happen-before-rule" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>The happens-before rule is a set of rules that define the order and visibility of actions in a program, especially in multi-threaded applications. This happens-before relationship ensures that there is a consistent order among operations. If operation <strong>A</strong> happens-before <strong>B</strong>, then the memory effects of <strong>A</strong> effectively become visible to the thread performing <strong>B</strong> before <strong>B</strong> is performed.</p>

<p>If we want an output of “00”, the operation <code class="language-plaintext highlighter-rouge">print(A);</code> must <em>happen-before</em> <code class="language-plaintext highlighter-rouge">A = 1;</code>. Samely, the operation <code class="language-plaintext highlighter-rouge">print(B)</code> should <em>happen-before</em> <code class="language-plaintext highlighter-rouge">B = 2;</code>.</p>

<p>However, the order of execution must be in the program order. Obviously, it is impossible to print “00”.</p>

<h3 id="c-memory-ordering"><span class="me-2">C++ Memory ordering</span><a href="#c-memory-ordering" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Memory order can be specified using the following enumeration:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">namespace</span> <span class="n">std</span><span class="p">{</span>
    <span class="k">typedef</span> <span class="k">enum</span> <span class="n">memory_order</span><span class="p">{</span>
        <span class="n">memory_order_relaxed</span><span class="p">,</span>
        <span class="n">memory_order_consume</span><span class="p">,</span>
        <span class="n">memory_order_acquire</span><span class="p">,</span>
        <span class="n">memory_order_release</span><span class="p">,</span>
        <span class="n">memory_order_acq_rel</span><span class="p">,</span>
        <span class="n">memory_order_seq_cst</span>
    <span class="p">}</span><span class="n">memory_order</span><span class="p">;</span> 
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The default for atomic variables is <code class="language-plaintext highlighter-rouge">memory_order_seq_cst</code>.</p>

<ul>
  <li>
    <p><strong><em>memory_order_seq_cst:</em></strong> A load operation with this memory order performs an acquire operation, a store performs a release operation, and read-modify-write performs both an acquire operation and a release operation</p>
  </li>
  <li>
    <p><strong><em>memory_order_acq_rel:</em></strong> A read-modify-write operation with this memory order is both an acquire operation and a release operation. No memory reads or writes in the current thread can be reordered before the load, nor after the store. All writes in other threads that release the same atomic variable are visible before the modification and the modification is visible in other threads that acquire the same atomic variable</p>
  </li>
  <li>
    <p><strong><em>memory_order_relaxed:</em></strong> No synchronization or ordering constraints imposed on other reads or writes, only this operation’s atomicity is guaranteed</p>
  </li>
  <li>
    <p><strong><em>memory_order_consume:</em></strong> A load operation with this memory order performs a consume operation on the affected memory location: no reads or writes in the current thread dependent on the value currently loaded can be reordered before this load. Writes to data-dependent variables in other threads that release the same atomic variable are visible in the current thread. On most platforms, this affects compiler optimizations only</p>
  </li>
  <li>
    <p><strong><em>memory_order_acquire:</em></strong> A load operation with this memory order performs the acquire operation on the affected memory location: no reads or writes in the current thread can be reordered before this load. All writes in other threads that release the same atomic variable are visible in the current thread</p>
  </li>
  <li>
    <p><strong><em>memory_order_release:</em></strong> A store operation with this memory order performs the release operation: no reads or writes in the current thread can be reordered after this store. All writes in the current thread are visible in other threads that acquire the same atomic variable (see Release-Acquire ordering below) and writes that carry a dependency into the atomic variable become visible in other threads that consume the same atomic</p>
  </li>
</ul>

<h3 id="sequential-consistency"><span class="me-2">Sequential Consistency</span><a href="#sequential-consistency" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Sequential Consistency(SC) is the simplest memory order.</p>

<blockquote>
  <p>“… the result of any execution is the same as if the operations of all the processors were executed in some sequential order, and the operations of each individual processor appear in this sequence in the order specified by its program.”
    – Leslie Lamport, “How to Make a Multiprocessor Computer That Correctly Executes Multiprocess Programs”, IEEE Trans. Comput. C-28,9 (Sept. 1979), 690-691.</p>
</blockquote>

<p>In summary, it follows two rules:</p>

<ul>
  <li>
    <p>The execution order of each processor is the same as the program order.</p>
  </li>
  <li>
    <p>All processors can only see one single order of execution.</p>
  </li>
</ul>

<p>When we add write cache to the core, some situations that are impossible under SC model become possible. It is called the <strong><em>Total Store Ordering</em></strong>.</p>

<p>We still use the example mentioned above:</p>

<p>In thread-1:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">A</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">A</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In thread-2:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">B</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="n">print</span><span class="p">(</span><span class="n">B</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>This time, threads write the new values of A and B into the cache and then returns immediately. It has not been updated to the memory yet. When the <code class="language-plaintext highlighter-rouge">print();</code> is called, the proccessor can only access the origin values of A and B, so the output can be <code class="language-plaintext highlighter-rouge">00</code>.</p>

<h3 id="relaxed-memory-models"><span class="me-2">Relaxed Memory Models</span><a href="#relaxed-memory-models" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>Neither of the above two memory models(SC &amp; TSO) changes the order of execution when a sigle thread executes. However the <strong><em>Relaxed Memory Model</em></strong> to be discussed here changes the order.</p>

<p>In the relaxed memory models, instructions can be reordered by the compiler while satisfying the final result of the single thread.</p>

<p>For a simple example, we use gcc to generate the assembly code of following code:</p>

<div class="language-c highlighter-rouge"><div class="code-header">
        <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">func</span><span class="p">(){</span>
  <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">B</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="n">func</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<div class="language-terminal highlighter-rouge"><div class="code-header">
        <span data-label-text="Terminal"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="go">gcc test.c -S
</span></pre></td></tr></tbody></table></code></div></div>

<p>The <code class="language-plaintext highlighter-rouge">test.s</code> will be like:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="rouge-code"><pre>    <span class="nf">.file</span>    <span class="s">"test.cpp"</span>
    <span class="nf">.text</span>
    <span class="nf">.globl</span>    <span class="nv">A</span>
    <span class="nf">.bss</span>
    <span class="nf">.align</span> <span class="mi">4</span>
    <span class="nf">.type</span>    <span class="nv">A</span><span class="p">,</span> <span class="err">@</span><span class="nv">object</span>
    <span class="nf">.size</span>    <span class="nv">A</span><span class="p">,</span> <span class="mi">4</span>
<span class="nl">A:</span>
    <span class="nf">.zero</span>    <span class="mi">4</span>
    <span class="nf">.globl</span>    <span class="nv">B</span>
    <span class="nf">.align</span> <span class="mi">4</span>
    <span class="nf">.type</span>    <span class="nv">B</span><span class="p">,</span> <span class="err">@</span><span class="nv">object</span>
    <span class="nf">.size</span>    <span class="nv">B</span><span class="p">,</span> <span class="mi">4</span>
<span class="nl">B:</span>
    <span class="nf">.zero</span>    <span class="mi">4</span>
    <span class="nf">.text</span>
    <span class="nf">.globl</span>    <span class="nv">_Z4funcv</span>
    <span class="nf">.type</span>    <span class="nv">_Z4funcv</span><span class="p">,</span> <span class="err">@</span><span class="nv">function</span>
<span class="nl">_Z4funcv:</span>
<span class="nl">.LFB0:</span>
    <span class="nf">.cfi_startproc</span>
    <span class="nf">pushq</span>    <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa_offset</span> <span class="mi">16</span>
    <span class="nf">.cfi_offset</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
    <span class="nf">movq</span>    <span class="o">%</span><span class="nb">rsp</span><span class="p">,</span> <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa_register</span> <span class="mi">6</span>
    <span class="nf">movl</span>    <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">),</span> <span class="o">%</span><span class="nb">eax</span>
    <span class="nf">addl</span>    <span class="kc">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="nb">eax</span>
    <span class="nf">movl</span>    <span class="o">%</span><span class="nb">eax</span><span class="p">,</span> <span class="nv">A</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
    <span class="nf">movl</span>    <span class="kc">$</span><span class="mi">0</span><span class="p">,</span> <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
    <span class="nf">nop</span>
    <span class="nf">popq</span>    <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
    <span class="nf">ret</span>
    <span class="nf">.cfi_endproc</span>
<span class="nl">.LFE0:</span>
    <span class="nf">.size</span>    <span class="nv">_Z4funcv</span><span class="p">,</span> <span class="nv">.</span><span class="o">-</span><span class="nv">_Z4funcv</span>
    <span class="nf">.globl</span>    <span class="nv">main</span>
    <span class="nf">.type</span>    <span class="nv">main</span><span class="p">,</span> <span class="err">@</span><span class="nv">function</span>
<span class="nl">main:</span>
<span class="nl">.LFB1:</span>
    <span class="nf">.cfi_startproc</span>
    <span class="nf">pushq</span>    <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa_offset</span> <span class="mi">16</span>
    <span class="nf">.cfi_offset</span> <span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">16</span>
    <span class="nf">movq</span>    <span class="o">%</span><span class="nb">rsp</span><span class="p">,</span> <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa_register</span> <span class="mi">6</span>
    <span class="nf">call</span>    <span class="nv">_Z4funcv</span>
    <span class="nf">movl</span>    <span class="kc">$</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="nb">eax</span>
    <span class="nf">popq</span>    <span class="o">%</span><span class="nb">rbp</span>
    <span class="nf">.cfi_def_cfa</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span>
    <span class="nf">ret</span>
    <span class="nf">.cfi_endproc</span>
<span class="nl">.LFE1:</span>
    <span class="nf">.size</span>    <span class="nv">main</span><span class="p">,</span> <span class="nv">.</span><span class="o">-</span><span class="nv">main</span>
    <span class="nf">.ident</span>    <span class="err">"</span><span class="nv">GCC</span><span class="p">:</span> <span class="p">(</span><span class="nv">Debian</span> <span class="mf">14.2</span><span class="nv">.0</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="mf">14.2</span><span class="nv">.0</span><span class="err">"</span>
    <span class="nf">.section</span>    <span class="nv">.note.GNU</span><span class="o">-</span><span class="nv">stack</span><span class="p">,</span><span class="s">""</span><span class="p">,</span><span class="err">@</span><span class="nv">progbits</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Let’s make it simple and focus only on the following instructions:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nf">movl</span>    <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">),</span> <span class="o">%</span><span class="nb">eax</span>
<span class="nf">addl</span>    <span class="kc">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="nb">eax</span>
<span class="nf">movl</span>    <span class="o">%</span><span class="nb">eax</span><span class="p">,</span> <span class="nv">A</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
<span class="nf">movl</span>    <span class="kc">$</span><span class="mi">0</span><span class="p">,</span> <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In these four lines of instructions, B will be firstly assigned to register <code class="language-plaintext highlighter-rouge">eax</code>, then the 1-added <code class="language-plaintext highlighter-rouge">eax</code> is assigned to A, finally set B to 0.</p>

<p>If we add -O2 to optimize(<code class="language-plaintext highlighter-rouge">gcc test.c -S -O2</code>), the assembly code will be different:</p>

<div class="language-nasm highlighter-rouge"><div class="code-header">
        <span data-label-text="Nasm"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nf">movl</span>    <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">),</span> <span class="o">%</span><span class="nb">eax</span>
<span class="nf">movl</span>    <span class="kc">$</span><span class="mi">0</span><span class="p">,</span> <span class="nv">B</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
<span class="nf">addl</span>    <span class="kc">$</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="nb">eax</span>
<span class="nf">movl</span>    <span class="o">%</span><span class="nb">eax</span><span class="p">,</span> <span class="nv">A</span><span class="p">(</span><span class="o">%</span><span class="nv">rip</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div>

<p>After assigning to <code class="language-plaintext highlighter-rouge">eax</code>, the B is immediately set to 1.</p>

<p>This shows that as long as the B is temporarily stored, the <code class="language-plaintext highlighter-rouge">movl</code> operations can be reordered without changing the final execution result.</p>

<h3 id="stdatomic"><span class="me-2">std::atomic</span><a href="#stdatomic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>In multi-threaded programming, synchronization problems between threads are unavoidable. Traditional synchronization methods, such as <code class="language-plaintext highlighter-rouge">mutex</code> and <em>condition variables</em>, may lead to performance degradation and deadlocks. C++11 introduces <code class="language-plaintext highlighter-rouge">atomic</code> operations, providing a more efficient and safe multi-threaded programming method. This article will introduce the concept, usage and examples of atomic operations in C++.</p>

<h4 id="stdatomic_flag"><span class="me-2">std::atomic_flag</span><a href="#stdatomic_flag" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p><code class="language-plaintext highlighter-rouge">std::atomic_flag</code> is the simplest atomic type, with only two states: <code class="language-plaintext highlighter-rouge">set</code> and <code class="language-plaintext highlighter-rouge">clear</code>. <code class="language-plaintext highlighter-rouge">std::atomic_flag</code> cannot be copied and assigned, and must be initialized using the <code class="language-plaintext highlighter-rouge">ATOMIC_FLAG_INIT</code> macro.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
  <span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span> <span class="n">flag</span> <span class="o">=</span> <span class="n">ATOMIC_FLAG_INIT</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">flag</span><span class="p">.</span><span class="n">test_and_set</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">flag</span><span class="p">.</span><span class="n">test_and_set</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">flag</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Think of <code class="language-plaintext highlighter-rouge">flag</code> as a boolean. Through this example, we found that <code class="language-plaintext highlighter-rouge">test_and_set()</code> can actually be regarded as two actions: <em>test</em> the <code class="language-plaintext highlighter-rouge">flag</code> first, that is, get the current status of <code class="language-plaintext highlighter-rouge">flag</code> as the return value, and then <em>set</em> it to <code class="language-plaintext highlighter-rouge">true</code>. These two actions cannot be interrupted in the middle. <code class="language-plaintext highlighter-rouge">clear()</code> sets <code class="language-plaintext highlighter-rouge">flag</code> to <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h4 id="stdatomic-1"><span class="me-2">std::atomic<T></T></span><a href="#stdatomic-1" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p><code class="language-plaintext highlighter-rouge">std::atomic</code> is a general atomic type that can be used for any copyable type <code class="language-plaintext highlighter-rouge">T</code>. <code class="language-plaintext highlighter-rouge">std::atomic</code> can be initialized using the default constructor, copy constructor or assignment operation.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">atomicInt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">atomicBool</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h4 id="atomic-operations"><span class="me-2">atomic operations</span><a href="#atomic-operations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<p>Basic atomic operations include <code class="language-plaintext highlighter-rouge">load()</code>, <code class="language-plaintext highlighter-rouge">store()</code>, <code class="language-plaintext highlighter-rouge">exchange()</code>, etc. <code class="language-plaintext highlighter-rouge">load()</code> can be used to read the value of an atomic variable, <code class="language-plaintext highlighter-rouge">store()</code> is used to set the value and the <code class="language-plaintext highlighter-rouge">exchange()</code> function atomically replaces the current value of an atomic variable with a new value and returns the old value.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">atomicInt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>    <span class="c1">// get value</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"value: "</span> <span class="o">&lt;&lt;</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">atomicInt</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>    <span class="c1">// set value</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"value: "</span> <span class="o">&lt;&lt;</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">old_value</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">exchange</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"old_value: "</span> <span class="o">&lt;&lt;</span> <span class="n">old_value</span> <span class="o">&lt;&lt;</span> <span class="s">", new_value: "</span> <span class="o">&lt;&lt;</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>Some simple arithmetic operations are atomically implemented by <code class="language-plaintext highlighter-rouge">fetch_add</code>, <code class="language-plaintext highlighter-rouge">fetch_sub</code>, <code class="language-plaintext highlighter-rouge">fetch_and</code>, <code class="language-plaintext highlighter-rouge">fetch_or</code>, <code class="language-plaintext highlighter-rouge">fetch_xor</code> and etc.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">counter</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">counter</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="n">counter</span><span class="p">.</span><span class="n">fetch_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<p>In computer science, <em>compare-and-swap</em> (<strong>CAS</strong>) is an atomic instruction used in multithreading to achieve synchronization. <code class="language-plaintext highlighter-rouge">std::atomic</code> also offers simple CAS supports like <code class="language-plaintext highlighter-rouge">compare_exchange_weak</code> and <code class="language-plaintext highlighter-rouge">compare_exchange_strong</code>. CAS contains an expected value and a new value, by comparing the current value with the expected value, CAS returns a boolean to tell whether the two values are the same. If they are the same, the new value will be stored, otherwise, the expected value will be set to the current value.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;atomic&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">atomicInt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">expected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">bool</span> <span class="n">success</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"success: "</span> <span class="o">&lt;&lt;</span> <span class="n">success</span> 
              <span class="o">&lt;&lt;</span> <span class="s">", expected: "</span> <span class="o">&lt;&lt;</span> <span class="n">expected</span>
              <span class="o">&lt;&lt;</span> <span class="s">", value: "</span> <span class="o">&lt;&lt;</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> 
              <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="n">expected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">success</span> <span class="o">=</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">compare_exchange_strong</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"success: "</span> <span class="o">&lt;&lt;</span> <span class="n">success</span> 
              <span class="o">&lt;&lt;</span> <span class="s">", expected: "</span> <span class="o">&lt;&lt;</span> <span class="n">expected</span> 
              <span class="o">&lt;&lt;</span> <span class="s">", value: "</span> <span class="o">&lt;&lt;</span> <span class="n">atomicInt</span><span class="p">.</span><span class="n">load</span><span class="p">()</span> 
              <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p>The key difference between <code class="language-plaintext highlighter-rouge">compare_exchange_strong</code> and <code class="language-plaintext highlighter-rouge">compare_exchange_weak</code> lies in their behavior regarding <strong>spurious failures</strong>. <code class="language-plaintext highlighter-rouge">compare_exchange_weak</code> may fail spuriously and <code class="language-plaintext highlighter-rouge">compare_exchange_strong</code> guarantees no spurious failures. Use <code class="language-plaintext highlighter-rouge">compare_exchange_weak</code> when efficiency is critical and you can tolerate the possibility of spurious failures or you can easily handle spurious failures in the code.</p>

<h4 id="spinlock-with-stdatomic"><span class="me-2">SpinLock with std::atomic</span><a href="#spinlock-with-stdatomic" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">SpinLock</span><span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">SpinLock</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span><span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span> <span class="o">:</span> <span class="n">flag</span><span class="p">(</span><span class="n">flag</span><span class="p">){</span>
        <span class="k">while</span><span class="p">(</span><span class="n">flag</span><span class="p">.</span><span class="n">test_and_set</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">SpinLock</span><span class="p">(){</span>
        <span class="n">flag</span><span class="p">.</span><span class="n">clear</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
    <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span><span class="o">&amp;</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span> <span class="n">flag</span><span class="p">;</span>
<span class="n">SpinLock</span> <span class="nf">spinlock</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="right-value-references"><span class="me-2">Right-Value References</span><a href="#right-value-references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Moving objects is generally much faster than copying them, especially for large objects or objects with complex internal structures.</p>

<p>A right-value reference is a special kind of reference that can only bind to <em>rvalues</em>.</p>

<p>The primary purpose of right-value references is to enable <strong>move semantics</strong>.</p>

<p>Move semantics allows efficient transfer of resources (like memory) from one object to another without the need for expensive copying operations.</p>

<p>When an object is moved, its resources are transferred to the new object, leaving the original object in a valid but unspecified state 1 (often empty).</p>

<p>WIth the help of Right-Value references, we can implement a perfect forwarding:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">forward_function</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;&amp;</span> <span class="n">param</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">func</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">param</span><span class="p">));</span>
    <span class="c1">// perfect forward to func</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">forward_function</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="n">forward_function</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="queue-buffer"><span class="me-2">Queue Buffer</span><a href="#queue-buffer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><code class="language-plaintext highlighter-rouge">BufferBase</code> is an abstracted base class defined some basic operations of a buffer. <code class="language-plaintext highlighter-rouge">push(LogLine&amp;&amp; logline)</code> pushes a log line to the buffer and <code class="language-plaintext highlighter-rouge">pop(LogLine&amp; logline)</code> popes it out. Use virtual destructors to ensure that derived classes are destructed correctly.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">BufferBase</span><span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">virtual</span> <span class="o">~</span><span class="n">BufferBase</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;&amp;</span> <span class="n">logline</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">pop</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;</span> <span class="n">logline</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">Buffer</code> is based on <code class="language-plaintext highlighter-rouge">BufferBase</code> and implements specific buffer functions. <code class="language-plaintext highlighter-rouge">Item</code> is used to store log lines. Each <code class="language-plaintext highlighter-rouge">item</code> has a <code class="language-plaintext highlighter-rouge">char padding</code> contains 256 padding bytes to ensure memory alignment.</p>

<p><code class="language-plaintext highlighter-rouge">write_state</code> records the state of each position.</p>

<p><code class="language-plaintext highlighter-rouge">static constexpr const size_t size = 32768;</code> defines the limit of this buffer(4 * 8 * 1024).</p>

<p>During the initialization phase, only the current thread is accessing the <code class="language-plaintext highlighter-rouge">write_state</code> array. There is no situation where multiple threads are accessing the same memory location at the same time, in this condition, <code class="language-plaintext highlighter-rouge">memory_order_relaxed</code> offers a more efficient way to initialize the <code class="language-plaintext highlighter-rouge">write_data</code>. Although a relaxed model is used, it does not mean that there is no order guarantee at all. Within the same thread, these initialization operations will still be executed in program order.</p>

<p>The  <code class="language-plaintext highlighter-rouge">memory_order_acquire</code> ensures that before executing this atomic operation, all previous read and write operations have completed and are visible to subsequent read operations. Which means, before the <code class="language-plaintext highlighter-rouge">fetch_add</code> operation is executed, the write operations to other positions in the <code class="language-plaintext highlighter-rouge">write_state</code> have been completed and are visible to subsequent read operations.</p>

<p>Copy constructor and assignment operator are disabled to avoid possible memory problems.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Buffer</span><span class="p">{</span>
<span class="nl">public:</span>
    <span class="k">struct</span> <span class="nc">Item</span><span class="p">{</span>
        <span class="kt">char</span> <span class="n">padding</span><span class="p">[</span><span class="mi">256</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LogLine</span><span class="p">)];</span>
        <span class="n">LogLine</span> <span class="n">logline</span><span class="p">;</span>
        <span class="n">Item</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;&amp;</span> <span class="n">logline</span><span class="p">)</span> <span class="o">:</span> <span class="n">logline</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">)){}</span>
    <span class="p">};</span>

    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">;</span>

    <span class="n">Buffer</span><span class="p">()</span> <span class="o">:</span> <span class="n">items</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Item</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="nf">sizeof</span><span class="p">(</span><span class="n">Item</span><span class="p">)))){</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>   <span class="n">write_state</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="k">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">256</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">~</span><span class="n">Buffer</span><span class="p">(){</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_cnt</span> <span class="o">=</span> <span class="n">write_state</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">load</span><span class="p">();</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">write_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>   <span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="o">~</span><span class="n">Item</span><span class="p">();</span>
        <span class="n">std</span><span class="o">::</span><span class="n">free</span><span class="p">(</span><span class="n">items</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">push</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;&amp;</span> <span class="n">logline</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_index</span><span class="p">){</span>
        <span class="k">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">items</span><span class="p">[</span><span class="n">write_index</span><span class="p">])</span> <span class="n">Item</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">));</span>
        <span class="n">write_state</span><span class="p">[</span><span class="n">write_index</span><span class="p">].</span><span class="n">store</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">write_state</span><span class="p">[</span><span class="n">size</span><span class="p">].</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">size</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">pop</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;</span> <span class="n">logline</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_index</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">write_state</span><span class="p">[</span><span class="n">read_index</span><span class="p">].</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)){</span>
            <span class="n">Item</span><span class="o">&amp;</span> <span class="n">item</span> <span class="o">=</span> <span class="n">items</span><span class="p">[</span><span class="n">read_index</span><span class="p">];</span>
            <span class="n">logline</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">logline</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">Buffer</span><span class="p">(</span><span class="k">const</span> <span class="n">Buffer</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">Buffer</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Buffer</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">Item</span> <span class="o">*</span><span class="n">items</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="n">write_state</span><span class="p">[</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="c1">// write_state[size]: write count</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">QueueBuffer</code> offers a thread-safe queue buffer for log lines.</p>

<p><code class="language-plaintext highlighter-rouge">buffers</code> is a <code class="language-plaintext highlighter-rouge">std::queue&lt;std::unique_ptr&lt;Buffer&gt;&gt;</code> type used to store smart pointers of multiple <code class="language-plaintext highlighter-rouge">Buffer</code> objects.</p>

<p><code class="language-plaintext highlighter-rouge">w_cursor</code> points to the currently writable buffer using atomic operations.</p>

<p><code class="language-plaintext highlighter-rouge">write_index</code> is a <code class="language-plaintext highlighter-rouge">std::atomic&lt;unsigned int&gt;</code> type that uses atomic operations to record the write index in the current writable buffer.</p>

<p>The <code class="language-plaintext highlighter-rouge">create_buffer()</code> function creates a new buffer and sets it as a writable buffer. When a thread updates <code class="language-plaintext highlighter-rouge">w_cursor</code> to the address of a new buffer, it wants other threads to see this update as soon as possible. <code class="language-plaintext highlighter-rouge">std::memory_order_release</code> ensures that all memory operations before performing this storage operation are visible to subsequent read operations. All memory operations preceding this <code class="language-plaintext highlighter-rouge">store</code> operation are visible to subsequent read operations. That is, when other threads read the new <code class="language-plaintext highlighter-rouge">w_cursor value</code>, they must also see the write to the data in <code class="language-plaintext highlighter-rouge">next_wbuffer</code>.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">QueueBuffer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">BufferBase</span><span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">QueueBuffer</span><span class="p">()</span> <span class="o">:</span> <span class="n">r_cursor</span><span class="p">{</span><span class="nb">nullptr</span><span class="p">},</span> <span class="n">write_index</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">flag</span><span class="p">{</span><span class="n">ATOMIC_FLAG_INIT</span><span class="p">},</span> <span class="n">read_index</span><span class="p">(</span><span class="mi">0</span><span class="p">){</span>
        <span class="n">create_buffer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">push</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;&amp;</span> <span class="n">logline</span><span class="p">)</span> <span class="k">override</span><span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">windex</span> <span class="o">=</span> <span class="n">write_index</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="n">windex</span> <span class="o">&lt;</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">size</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">w_cursor</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">),</span> <span class="n">windex</span><span class="p">)){</span>
                <span class="n">create_buffer</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span><span class="k">else</span><span class="p">{</span>
            <span class="k">while</span><span class="p">(</span><span class="n">write_index</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">size</span><span class="p">);</span>
            <span class="c1">// wait until buffer is available</span>
            <span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">bool</span> <span class="nf">pop</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;</span> <span class="n">logline</span><span class="p">)</span> <span class="k">override</span><span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">r_cursor</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>  <span class="n">r_cursor</span> <span class="o">=</span> <span class="n">get_rbuffer</span><span class="p">();</span>
        <span class="n">Buffer</span> <span class="o">*</span><span class="n">rcursor</span> <span class="o">=</span> <span class="n">r_cursor</span><span class="p">;</span> <span class="c1">// avoid race conditions</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rcursor</span> <span class="o">==</span> <span class="nb">nullptr</span><span class="p">)</span>  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">rcursor</span> <span class="o">-&gt;</span> <span class="n">pop</span><span class="p">(</span><span class="n">logline</span><span class="p">,</span> <span class="n">read_index</span><span class="p">)){</span>
            <span class="n">read_index</span><span class="o">++</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="n">read_index</span> <span class="o">==</span> <span class="n">Buffer</span><span class="o">::</span><span class="n">size</span><span class="p">){</span>
                <span class="n">read_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">r_cursor</span> <span class="o">=</span> <span class="nb">nullptr</span><span class="p">;</span>
                <span class="n">SpinLock</span> <span class="n">spinlock</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
                <span class="n">buffers</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">QueueBuffer</span><span class="p">(</span><span class="k">const</span> <span class="n">QueueBuffer</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="n">QueueBuffer</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">QueueBuffer</span><span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">delete</span><span class="p">;</span>
    <span class="c1">// disable copy constructor</span>

<span class="k">private</span><span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;&gt;</span><span class="n">buffers</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">*&gt;</span><span class="n">w_cursor</span><span class="p">;</span>   <span class="c1">//current write buffer</span>
    <span class="n">Buffer</span><span class="o">*</span> <span class="n">r_cursor</span><span class="p">;</span>    <span class="c1">//current read buffer</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span><span class="n">write_index</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_index</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic_flag</span> <span class="n">flag</span><span class="p">;</span>

    <span class="kt">void</span> <span class="nf">create_buffer</span><span class="p">(){</span>
        <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="n">next_wbuffer</span><span class="p">(</span><span class="k">new</span> <span class="n">Buffer</span><span class="p">());</span>
        <span class="n">w_cursor</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">next_wbuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
        <span class="n">SpinLock</span> <span class="n">spinlock</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
        <span class="n">buffers</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">next_wbuffer</span><span class="p">));</span>
        <span class="n">write_index</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_relaxed</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">Buffer</span><span class="o">*</span> <span class="nf">get_rbuffer</span><span class="p">(){</span>
        <span class="n">SpinLock</span> <span class="n">spinlock</span><span class="p">(</span><span class="n">flag</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buffers</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">?</span> <span class="nb">nullptr</span> <span class="o">:</span> <span class="n">buffers</span><span class="p">.</span><span class="n">front</span><span class="p">().</span><span class="n">get</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="logger-class"><span class="me-2">Logger Class</span><a href="#logger-class" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p><code class="language-plaintext highlighter-rouge">State</code> enum defines three possible states for the logger: <code class="language-plaintext highlighter-rouge">INIT</code> (during initialization), <code class="language-plaintext highlighter-rouge">ENABLED</code> (ready to log messages), and <code class="language-plaintext highlighter-rouge">DISABLED</code> (shutting down).</p>

<p><code class="language-plaintext highlighter-rouge">pop()</code> is designed to run in a separate thread within the <code class="language-plaintext highlighter-rouge">Logger</code> class. <code class="language-plaintext highlighter-rouge">std::memory_order_acquire</code> is crucial here. It ensures that any memory accesses that happened before the <code class="language-plaintext highlighter-rouge">state</code> was set to <code class="language-plaintext highlighter-rouge">ENABLED</code> are visible to this thread. This prevents the <code class="language-plaintext highlighter-rouge">pop</code> thread from starting to process log messages before the <code class="language-plaintext highlighter-rouge">Logger</code> object is fully initialized (including the <code class="language-plaintext highlighter-rouge">buffer_queue</code> and <code class="language-plaintext highlighter-rouge">file_writer</code>). The second loop, <code class="language-plaintext highlighter-rouge">while(buffer_queue -&gt; pop(logline)) file_writer.write(logline);</code>, which runs after the <code class="language-plaintext highlighter-rouge">state</code> has transitioned to <code class="language-plaintext highlighter-rouge">State::DISABLED</code> is designed to read and write any remaining log lines that might still be present in the <code class="language-plaintext highlighter-rouge">buffer_queue</code> before the logger is completely shut down. This offers a graceful shutdown which ensures that no log lines are lost even if the <code class="language-plaintext highlighter-rouge">state</code> is changed to <code class="language-plaintext highlighter-rouge">DISABLED</code> while there are still messages in the buffer.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Logger</span><span class="p">{</span>
<span class="nl">public:</span>
    <span class="n">Logger</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">roll_size</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">state</span><span class="p">(</span><span class="n">State</span><span class="o">::</span><span class="n">INIT</span><span class="p">),</span>
      <span class="n">buffer_queue</span><span class="p">(</span><span class="k">new</span> <span class="n">QueueBuffer</span><span class="p">()),</span>
      <span class="n">file_writer</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="n">roll_size</span><span class="p">)),</span>
      <span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Logger</span><span class="o">::</span><span class="n">pop</span><span class="p">,</span> <span class="k">this</span><span class="p">){</span>
        <span class="n">state</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">State</span><span class="o">::</span><span class="n">ENABLED</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="o">~</span><span class="n">Logger</span><span class="p">(){</span>
        <span class="n">state</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">State</span><span class="o">::</span><span class="n">DISABLED</span><span class="p">);</span>
        <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>    <span class="c1">// Waits for the thread to finish execution</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">add</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;&amp;</span> <span class="n">logline</span><span class="p">){</span>
        <span class="n">buffer_queue</span> <span class="o">-&gt;</span> <span class="n">push</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">pop</span><span class="p">(){</span>
        <span class="k">while</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">==</span> <span class="n">State</span><span class="o">::</span><span class="n">INIT</span><span class="p">);</span>
        <span class="c1">// wait until constructor is finished</span>
        <span class="n">LogLine</span> <span class="n">logline</span><span class="p">(</span><span class="n">LogSeverity</span><span class="o">::</span><span class="n">INFO</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="nb">nullptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">while</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_seq_cst</span><span class="p">)</span> <span class="o">==</span> <span class="n">State</span><span class="o">::</span><span class="n">ENABLED</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="n">buffer_queue</span> <span class="o">-&gt;</span> <span class="n">pop</span><span class="p">(</span><span class="n">logline</span><span class="p">))</span>    <span class="n">file_writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">logline</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// read remaining log</span>
        <span class="k">while</span><span class="p">(</span><span class="n">buffer_queue</span> <span class="o">-&gt;</span> <span class="n">pop</span><span class="p">(</span><span class="n">logline</span><span class="p">))</span> <span class="n">file_writer</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">logline</span><span class="p">);</span>
    <span class="p">}</span>
          
<span class="k">private</span><span class="o">:</span>
    <span class="k">enum</span> <span class="k">class</span> <span class="nc">State</span><span class="p">{</span>
        <span class="n">INIT</span><span class="p">,</span>
        <span class="n">ENABLED</span><span class="p">,</span>
        <span class="n">DISABLED</span><span class="p">,</span>
    <span class="p">};</span>
    <span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">State</span><span class="o">&gt;</span><span class="n">state</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BufferBase</span><span class="o">&gt;</span><span class="n">buffer_queue</span><span class="p">;</span>
    <span class="n">FileWriter</span> <span class="n">file_writer</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span> <span class="kr">thread</span><span class="p">;</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></div></div>

<h2 id="init-a-logger"><span class="me-2">Init a logger</span><a href="#init-a-logger" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">&gt;</span><span class="n">logger</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">Logger</span><span class="o">*&gt;</span><span class="n">atomic_logger</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">init</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">dir</span><span class="p">,</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">filename</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">roll_size</span><span class="p">){</span>
    <span class="n">logger</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">Logger</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">roll_size</span><span class="p">));</span>
    <span class="n">atomic_logger</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">logger</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">memory_order_seq_cst</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">std::memory_order_seq_cst</code> enforces the strongest ordering guarantees, ensuring that all memory accesses performed before the atomic operation are visible to all threads in the program in the order they were issued. The <code class="language-plaintext highlighter-rouge">init</code> function might be called from multiple threads concurrently. Without <code class="language-plaintext highlighter-rouge">seq_cst</code> order, another thread could potentially see an inconsistent state of the <code class="language-plaintext highlighter-rouge">atomic_logger</code>.</p>

<h2 id="severity-level"><span class="me-2">Severity Level</span><a href="#severity-level" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Use enum class <code class="language-plaintext highlighter-rouge">LogSeverity</code> to represent severity levels.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="cp">#ifndef BASE_LOG_SEVERITY_H__
#define BASE_LOG_SEVERITY_H__
#include</span> <span class="cpf">&lt;cstdint&gt;</span><span class="cp">
</span>
<span class="k">namespace</span> <span class="n">slog</span><span class="p">{</span>
    <span class="k">enum</span> <span class="k">class</span> <span class="nc">LogSeverity</span> <span class="o">:</span> <span class="kt">uint8_t</span> <span class="p">{</span> 
        <span class="n">DEBUG</span><span class="p">,</span> 
        <span class="n">INFO</span><span class="p">,</span> 
        <span class="n">ERROR</span><span class="p">,</span> 
        <span class="n">WARN</span><span class="p">,</span> 
        <span class="n">FATAL</span> 
    <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="log-line-time"><span class="me-2">Log Line Time</span><a href="#log-line-time" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Use <code class="language-plaintext highlighter-rouge">std::chrono</code> to porovide precise timestamp information for logging.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre><span class="cp">#ifndef SLOGTIME_H
#define SLOGTIME_H
#include</span> <span class="cpf">&lt;chrono&gt;</span><span class="cp">
</span>
<span class="k">namespace</span> <span class="n">slogtime</span><span class="p">{</span>
    <span class="k">class</span> <span class="nc">LogLineTime</span><span class="p">{</span>
    <span class="nl">public:</span>
        <span class="n">LogLineTime</span><span class="p">();</span>
        <span class="k">explicit</span> <span class="n">LogLineTime</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">now</span><span class="p">);</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span><span class="o">&amp;</span> <span class="n">when</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">timestamp</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">sec</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_sec</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="nf">usec</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">usecs</span><span class="p">.</span><span class="n">count</span><span class="p">();}</span>
        <span class="kt">int</span> <span class="n">min</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_min</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">hour</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_hour</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">day</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_mday</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">month</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">year</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">dayOfWeek</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_wday</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">dayInYear</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_yday</span><span class="p">;}</span>
        <span class="kt">int</span> <span class="n">dst</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">.</span><span class="n">tm_isdst</span><span class="p">;}</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span> <span class="n">gmtoffset</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">gmtoffset_</span><span class="p">;}</span>
        <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">tm</span><span class="o">&amp;</span> <span class="n">tm</span><span class="p">()</span> <span class="k">const</span> <span class="k">noexcept</span><span class="p">{</span><span class="k">return</span> <span class="n">tm_</span><span class="p">;}</span>
    <span class="k">private</span><span class="o">:</span>
        <span class="n">std</span><span class="o">::</span><span class="n">tm</span> <span class="n">tm_</span><span class="p">{};</span>  <span class="c1">// time of creation of LogLine</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">timestamp</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span> <span class="n">usecs</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span> <span class="n">gmtoffset_</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="cp">#endif // SLOGTIME_H
</span></pre></td></tr></tbody></table></code></div></div>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="n">LogLineTime</span><span class="o">::</span><span class="n">LogLineTime</span><span class="p">()</span> <span class="o">:</span> <span class="n">LogLineTime</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">())</span> <span class="p">{}</span>

<span class="n">LogLineTime</span><span class="o">::</span><span class="n">LogLineTime</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">now</span><span class="p">)</span> <span class="o">:</span> <span class="n">timestamp</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">tt</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">to_time_t</span><span class="p">(</span><span class="n">now</span><span class="p">);</span>
    <span class="n">gmtoffset_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">tm_gmtoff</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">tm</span><span class="o">*</span> <span class="n">ptm</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">localtime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tt</span><span class="p">);</span>
    <span class="n">tm_</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptm</span><span class="p">;</span>
    <span class="n">usecs</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">from_time_t</span><span class="p">(</span><span class="n">tt</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">slogtime</span><span class="o">::</span><span class="n">LogLineTime</span> <span class="n">now</span><span class="p">;</span> 
<span class="kt">int</span> <span class="n">hour</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">hour</span><span class="p">();</span>
<span class="kt">int</span> <span class="n">minute</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">min</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Current time: "</span> <span class="o">&lt;&lt;</span> <span class="n">hour</span> <span class="o">&lt;&lt;</span> <span class="s">":"</span> <span class="o">&lt;&lt;</span> <span class="n">minute</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="stream-to-string"><span class="me-2">Stream to String</span><a href="#stream-to-string" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="reinterpret_cast"><span class="me-2">reinterpret_cast<T></T></span><a href="#reinterpret_cast" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">reinterpret_cast</code> is a cast operator that performs a <strong>low-level, non-portable</strong> reinterpretation of the bit pattern of an object. It essentially treats the memory occupied by one data type as if it held a different data type. This means it doesn’t perform any type conversions or checks. We usually use <code class="language-plaintext highlighter-rouge">reinterpret_cast</code> to cast between different pointer types. In some low-level operations such as accessing raw memories(e.g., memory-mapped I/O), memory management, <code class="language-plaintext highlighter-rouge">reinterpret_cast</code> is also widely used. However, incorrect use can lead to undefined behavior, crashes, and security vulnerabilities. The behavior of <code class="language-plaintext highlighter-rouge">reinterpret_cast</code> can be platform-specific due to differences in memory representations (e.g., endianness).</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">LogLine</span><span class="o">::</span><span class="n">stream_to_string</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">){</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="o">!</span><span class="n">heap_buffer</span> <span class="o">?</span> <span class="n">stack_buffer</span> <span class="o">:</span> <span class="n">heap_buffer</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">end</span> <span class="o">=</span> <span class="n">data</span> <span class="o">+</span> <span class="n">used_bytes</span><span class="p">;</span>

    <span class="n">slogtime</span><span class="o">::</span><span class="n">LogLineTime</span> <span class="n">timenow</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">slogtime</span><span class="o">::</span><span class="n">LogLineTime</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slogtime</span><span class="o">::</span><span class="n">LogLineTime</span><span class="p">);</span>
    
    <span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span> <span class="n">threadid</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">id</span><span class="p">);</span>

    <span class="n">string_literal_t</span> <span class="n">file</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">string_literal_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">string_literal_t</span><span class="p">);</span>

    <span class="n">string_literal_t</span> <span class="n">function</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">string_literal_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">string_literal_t</span><span class="p">);</span>

    <span class="kt">uint32_t</span> <span class="n">line</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span> 
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">);</span>

    <span class="n">LogSeverity</span> <span class="n">loglevel</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">LogSeverity</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">data</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LogSeverity</span><span class="p">);</span>

    
    
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="sc">'['</span> <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">year</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'-'</span> \
             <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">month</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'-'</span> \
             <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">day</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="sc">'-'</span> \
             <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">hour</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">timenow</span><span class="p">.</span><span class="n">sec</span><span class="p">();</span>
   
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="sc">'['</span> <span class="o">&lt;&lt;</span> <span class="n">level_to_string</span><span class="p">(</span><span class="n">loglevel</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="sc">']'</span>
      <span class="o">&lt;&lt;</span> <span class="sc">'['</span> <span class="o">&lt;&lt;</span> <span class="n">threadid</span> <span class="o">&lt;&lt;</span> <span class="sc">']'</span>
      <span class="o">&lt;&lt;</span> <span class="sc">'['</span> <span class="o">&lt;&lt;</span> <span class="n">file</span><span class="p">.</span><span class="n">s</span>
      <span class="o">&lt;&lt;</span> <span class="sc">':'</span> <span class="o">&lt;&lt;</span> <span class="n">function</span><span class="p">.</span><span class="n">s</span>
      <span class="o">&lt;&lt;</span> <span class="sc">':'</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="s">"] "</span><span class="p">;</span>

    <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>

    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">loglevel</span> <span class="o">==</span> <span class="n">LogSeverity</span><span class="o">::</span><span class="n">FATAL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">s</span><span class="p">.</span><span class="n">flush</span><span class="p">();</span>
    <span class="p">}</span>      
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="decode"><span class="me-2">Decode</span><a href="#decode" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<h4 id="generic-template"><span class="me-2">Generic Template:</span><a href="#generic-template" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">decode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">T</span><span class="o">*</span> <span class="n">dummy</span><span class="p">){</span>
    <span class="n">T</span> <span class="n">arg</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">arg</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">T* dummy</code> is a pointer to a dummy object of type <code class="language-plaintext highlighter-rouge">T</code>. This parameter is used to provide type information to the compiler during template instantiation.</p>

<h4 id="specialization-for-loglinestring_literal_t"><span class="me-2">Specialization for <code class="language-plaintext highlighter-rouge">LogLine::string_literal_t</code>:</span><a href="#specialization-for-loglinestring_literal_t" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="k">template</span><span class="o">&lt;</span><span class="p">&gt;</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">decode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">LogLine</span><span class="o">::</span><span class="n">string_literal_t</span><span class="o">*</span> <span class="n">dummy</span><span class="p">){</span>
    <span class="n">LogLine</span><span class="o">::</span><span class="n">string_literal_t</span> <span class="n">sliteral</span> <span class="o">=</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">LogLine</span><span class="o">::</span><span class="n">string_literal_t</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="n">sliteral</span><span class="p">.</span><span class="n">s</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">LogLine</span><span class="o">::</span><span class="n">string_literal_t</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">s &lt;&lt; sliteral.s;</code> writes the actual string (<code class="language-plaintext highlighter-rouge">sliteral.s</code>) to the output stream.</p>

<h4 id="specialization-for-char"><span class="me-2">Specialization for <code class="language-plaintext highlighter-rouge">char*</code>:</span><a href="#specialization-for-char" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="k">template</span><span class="o">&lt;</span><span class="p">&gt;</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">decode</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">dummy</span><span class="p">){</span>
    <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">){</span>
        <span class="n">s</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
        <span class="o">++</span><span class="n">data</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">++</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<p><code class="language-plaintext highlighter-rouge">return ++data;</code> returns a pointer to the position after the null terminator.</p>

<h3 id="types-definition"><span class="me-2">Types Definition</span><a href="#types-definition" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>All the types to be encoded/decoded is defined in a tuple:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="kt">int32_t</span><span class="p">,</span> <span class="kt">int64_t</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">,</span> <span class="kt">double</span><span class="p">,</span> <span class="n">LogLine</span><span class="o">::</span><span class="n">string_literal_t</span><span class="o">&gt;</span> <span class="n">DataTypes</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="tuple-helper"><span class="me-2">Tuple Helper</span><a href="#tuple-helper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>A tuple helper is used to locate different types in the tuple:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">Tuple</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">TupleIndexHelper</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">TupleIndexHelper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;&gt;&gt;</span><span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span><span class="nc">Types</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">TupleIndexHelper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Types</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">T</span><span class="p">,</span> <span class="k">typename</span> <span class="nc">U</span><span class="p">,</span> <span class="k">typename</span><span class="o">...</span><span class="nc">Types</span><span class="p">&gt;</span>
<span class="k">struct</span> <span class="nc">TupleIndexHelper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">Types</span><span class="p">...</span><span class="o">&gt;&gt;</span><span class="p">{</span>
    <span class="k">static</span> <span class="k">constexpr</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">TupleIndexHelper</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">tuple</span><span class="o">&lt;</span><span class="n">Types</span><span class="p">...</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="p">;</span>
<span class="p">};</span>  <span class="c1">// recursive steps to find Type index</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="stream_to_string-recursive"><span class="me-2"><code class="language-plaintext highlighter-rouge">stream_to_string</code> Recursive</span><a href="#stream_to_string-recursive" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">LogLine</span><span class="o">::</span><span class="n">stream_to_string</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">start</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">end</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>    <span class="k">return</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">);</span>
    <span class="n">start</span><span class="o">++</span><span class="p">;</span>
        
    <span class="k">switch</span><span class="p">(</span><span class="n">id</span><span class="p">){</span>
        <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">6</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">7</span><span class="p">:</span>
            <span class="n">stream_to_string</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">decode</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">tuple_element</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="n">DataTypes</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*&gt;</span><span class="p">(</span><span class="nb">nullptr</span><span class="p">)),</span> <span class="n">end</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

<h2 id="macros"><span class="me-2">Macros</span><a href="#macros" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<h3 id="log-macros"><span class="me-2">Log Macros</span><a href="#log-macros" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p><code class="language-plaintext highlighter-rouge">operator+=</code> is used to add one log line to <code class="language-plaintext highlighter-rouge">Slog</code>.</p>

<p><code class="language-plaintext highlighter-rouge">std::memory_order_acquire</code> ensures that the acquired pointer is up-to-date and that any operations on the logger after acquiring the pointer will be performed in order.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">Slog</span><span class="p">{</span>
    <span class="kt">bool</span> <span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;</span> <span class="n">logline</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">bool</span> <span class="n">Slog</span><span class="o">::</span><span class="k">operator</span><span class="o">+=</span><span class="p">(</span><span class="n">LogLine</span><span class="o">&amp;</span> <span class="n">logline</span><span class="p">){</span>
    <span class="n">atomic_logger</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">add</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">logline</span><span class="p">));</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SLOG(LEVEL) slog::Slog() += slog::LogLine(LEVEL, __FILE__, __func__, __LINE__)
#define LOG_DEBUG SLOG(slog::LogSeverity::DEBUG)
#define LOG_INFO SLOG(slog::LogSeverity::INFO)
#define LOG_ERROR SLOG(slog::LogSeverity::ERROR)
#define LOG_WARN SLOG(slog::LogSeverity::WARN)
#define LOG_FATAL SLOG(slog::LogSeverity::FATAL)
</span></pre></td></tr></tbody></table></code></div></div>

<p>Log messages with a stream style:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="n">info</span> <span class="o">&lt;&lt;</span> <span class="mi">123</span> <span class="o">&lt;&lt;</span> <span class="mf">12.34</span><span class="p">;</span>
<span class="n">LOG_FATAL</span> <span class="o">&lt;&lt;</span> <span class="s">"fatal error: "</span> <span class="o">&lt;&lt;</span> <span class="n">str</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></div></div>

<h3 id="assert-macros"><span class="me-2">Assert Macros</span><a href="#assert-macros" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3>

<p>In most cases, assert functions can be implemented using macros.</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#define CHECK(condition) \
    if (!(condition)){ \
        LOG_FATAL &lt;&lt; "CHECK failed: " &lt;&lt; #condition; \
    }
</span></pre></td></tr></tbody></table></code></div></div>

<p>Use <code class="language-plaintext highlighter-rouge">std::abort();</code> to abort the program. An error will be shown:</p>

<div class="language-terminal highlighter-rouge"><div class="code-header">
        <span data-label-text="Terminal"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="go">zsh IOT instruction (core dumped)
</span></pre></td></tr></tbody></table></code></div></div>

<p>Check pointer:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="cp">#define CHECK_P(ptr) \
    if ((ptr) == nullptr){ \
        LOG_WARN&lt;&lt; "CHECK_P failed: pointer " &lt;&lt; #ptr &lt;&lt; " is null"; \
    }
</span></pre></td></tr></tbody></table></code></div></div>

<p>Check string:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="kt">bool</span> <span class="nf">strcasecmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">s2</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s1</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s2</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">s1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tolower</span><span class="p">(</span><span class="o">*</span><span class="n">s2</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">s1</span><span class="o">++</span><span class="p">;</span>
        <span class="n">s2</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">*</span><span class="n">s1</span> <span class="o">==</span> <span class="o">*</span><span class="n">s2</span><span class="p">;</span>  
<span class="p">}</span>

<span class="cp">#define CHECK_STREQ(str1, str2) \
    if (strcmp(str1, str2) != 0) { \
        LOG_WARN &lt;&lt; "CHECK_STREQ failed: \"" &lt;&lt; str1 &lt;&lt; "\" != \"" &lt;&lt; str2 &lt;&lt; "\""; \
    }
</span>

<span class="cp">#define CHECK_STREQ_CASE(str1, str2) \
    if (!strcasecmp(str1, str2)) { \
        LOG_WARN &lt;&lt; "CHECK_STREQ_CASE failed: \"" &lt;&lt; str1 &lt;&lt; "\" != \"" &lt;&lt; str2 &lt;&lt; "\""; \
    }
</span></pre></td></tr></tbody></table></code></div></div>

<h2 id="test-the-logger"><span class="me-2">Test the logger</span><a href="#test-the-logger" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2>

<p>Test the logger in a simple multi-thread environment:</p>

<div class="language-cpp highlighter-rouge"><div class="code-header">
        <span data-label-text="Cpp"><i class="fas fa-code fa-fw small"></i></span>
      <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"include/slog.h"</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;ctime&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">benchmark</span><span class="p">(){</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">str</span> <span class="o">=</span> <span class="s">"benchmark"</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">"Logging-"</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">"-double-"</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="mf">99.876</span> <span class="o">&lt;&lt;</span> <span class="s">"-uint64-"</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="kt">uint64_t</span><span class="p">)</span><span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
    <span class="k">auto</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
    <span class="kt">long</span> <span class="kt">int</span> <span class="n">avg</span> <span class="o">=</span> <span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Avg: %ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">avg</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Total: %ld</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">duration</span><span class="p">.</span><span class="n">count</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">F</span><span class="p">&gt;</span>
<span class="kt">void</span> <span class="nf">create_thread</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;&amp;</span> <span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">&gt;</span><span class="n">threads</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">threads</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">threads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">join</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">slog</span><span class="o">::</span><span class="n">init</span><span class="p">(</span><span class="s">"/tmp/log/"</span><span class="p">,</span> <span class="s">"log"</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="k">auto</span> <span class="n">threads</span><span class="o">:</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">}){</span>
        <span class="n">create_thread</span><span class="p">(</span><span class="n">benchmark</span><span class="p">,</span> <span class="n">threads</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">LOG_INFO</span> <span class="o">&lt;&lt;</span> <span class="s">"HELLO"</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">b</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">CHECK_EQ_F</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div>

  </div>

  <div class="post-tail-wrapper text-muted">
    <!-- categories -->
    
      <div class="post-meta mb-3">
        <i class="far fa-folder-open fa-fw me-1"></i>
        
          <a href="/categories/c-c/">C/C++</a>
      </div>
    

    <!-- tags -->
    
      <div class="post-tags">
        <i class="fa fa-tags fa-fw me-1"></i>
        
          <a
            href="/tags/c-c/"
            class="post-tag no-text-decoration"
          >C/C++</a>
        
          <a
            href="/tags/logger/"
            class="post-tag no-text-decoration"
          >Logger</a>
        
          <a
            href="/tags/linux/"
            class="post-tag no-text-decoration"
          >Linux</a>
        
          <a
            href="/tags/thread/"
            class="post-tag no-text-decoration"
          >Thread</a>
        
      </div>
    

    <div
      class="
        post-tail-bottom
        d-flex justify-content-between align-items-center mt-5 pb-2
      "
    >
      <div class="license-wrapper">
        
          

          This post is licensed under 
        <a href="https://creativecommons.org/licenses/by/4.0/">
          CC BY 4.0
        </a>
         by the author.
        
      </div>

      <!-- Post sharing snippet -->

<div class="share-wrapper d-flex align-items-center">
  <span class="share-label text-muted">Share</span>
  <span class="share-icons">
    
    
    

    

      

      <a href="https://twitter.com/intent/tweet?text=Simple%20Thread-safe%20Logger%20in%20C++%20-%20Blog%20-%20the0cp&url=https%3A%2F%2Fthe0cp.cc%2Fposts%2Flogger%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter">
        <i class="fa-fw fa-brands fa-square-x-twitter"></i>
      </a>
    

      

      <a href="https://www.facebook.com/sharer/sharer.php?title=Simple%20Thread-safe%20Logger%20in%20C++%20-%20Blog%20-%20the0cp&u=https%3A%2F%2Fthe0cp.cc%2Fposts%2Flogger%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook">
        <i class="fa-fw fab fa-facebook-square"></i>
      </a>
    

      

      <a href="https://t.me/share/url?url=https%3A%2F%2Fthe0cp.cc%2Fposts%2Flogger%2F&text=Simple%20Thread-safe%20Logger%20in%20C++%20-%20Blog%20-%20the0cp" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram">
        <i class="fa-fw fab fa-telegram"></i>
      </a>
    

      

      <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fthe0cp.cc%2Fposts%2Flogger%2F&title=Simple%20Thread-safe%20Logger%20in%20C++%20-%20Blog%20-%20the0cp" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit">
        <i class="fa-fw fa-brands fa-square-reddit"></i>
      </a>
    

    <button
      id="copy-link"
      aria-label="Copy link"
      class="btn small"
      data-bs-toggle="tooltip"
      data-bs-placement="top"
      title="Copy link"
      data-title-succeed="Link copied successfully!"
    >
      <i class="fa-fw fas fa-link pe-none fs-6"></i>
    </button>
  </span>
</div>

    </div>
    <!-- .post-tail-bottom -->
  </div>
  <!-- div.post-tail-wrapper -->
</article>


            
          </main>

          <!-- panel -->
          <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted">
            <div class="access">
              <!-- Get 5 last posted/updated posts -->














  <section id="access-lastmod">
    <h2 class="panel-heading">Recently Updated</h2>
    <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/mathjax/">MathJax Cheat Sheet in LaTeX</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/qrcode/">How do QR Codes Work - Overview of the QR Code</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/infinitesimals/">Some Simple Equivalent Infinitesimals</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/logger/">Simple Thread-safe Logger in C++</a>
        </li>
      
        
        
        
        <li class="text-truncate lh-lg">
          <a href="/posts/database/">B+ Tree Database in Modern C++</a>
        </li>
      
    </ul>
  </section>
  <!-- #access-lastmod -->


              <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">C/C++</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pentest/">Pentest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/qt/">Qt</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/beautify/">Beautify</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blogging/">Blogging</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/github/">Github</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hexo/">Hexo</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/math/">Math</a>
      
    </div>
  </section>


            </div>

            
              
              






  <section id="toc-wrapper" class="ps-0 pe-4">
    <h2 class="panel-heading ps-3 mb-2">Contents</h2>
    <nav id="toc"></nav>
  </section>


            
          </aside>
        </div>

        <div class="row">
          <!-- tail -->
          <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
            
              
              <!-- Recommend the other 3 posts according to the tags and categories of the current post. -->

<!-- The total size of related posts -->


<!-- An random integer that bigger than 0 -->


<!-- Equals to TAG_SCORE / {max_categories_hierarchy} -->















  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    










  <aside id="related-posts" aria-labelledby="related-label">
    <h3 class="mb-4" id="related-label">Further Reading</h3>
    <nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4">
      
        <article class="col">
          <a href="/posts/database/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1733324400"
  data-df="ll"
  
>
  Dec  5, 2024
</time>

              <h4 class="pt-0 my-2">B+ Tree Database in Modern C++</h4>
              <div class="text-muted">
                <p>A B+ Tree based local database in Modern C++.</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/C-Tutorial-arg/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1608908400"
  data-df="ll"
  
>
  Dec 26, 2020
</time>

              <h4 class="pt-0 my-2">C Tutorial -- Command Line Arguments</h4>
              <div class="text-muted">
                <p>When executing the program, you can pass values to the C program from the command line. These values are called command line arguments...</p>
              </div>
            </div>
          </a>
        </article>
      
        <article class="col">
          <a href="/posts/linux-bingbg/" class="post-preview card h-100">
            <div class="card-body">
              <!--
  Date format snippet
  See: ${JS_ROOT}/utils/locale-dateime.js
-->




<time
  
  data-ts="1606575600"
  data-df="ll"
  
>
  Nov 29, 2020
</time>

              <h4 class="pt-0 my-2">Linux, C | Bing Backgrounds Getter</h4>
              <div class="text-muted">
                <p>Linux C Program which automatically downloads and sets wallpapers from bing.com</p>
              </div>
            </div>
          </a>
        </article>
      
    </nav>
  </aside>
  <!-- #related-posts -->


            
              
              <!-- Navigation buttons at the bottom of the post. -->

<nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation">
  
  

  
    <a
      href="/posts/database/"
      class="btn btn-outline-primary"
      aria-label="Older"
    >
      <p>B+ Tree Database in Modern C++</p>
    </a>
  

  
    <a
      href="/posts/infinitesimals/"
      class="btn btn-outline-primary"
      aria-label="Newer"
    >
      <p>Some Simple Equivalent Infinitesimals</p>
    </a>
  
</nav>

            
              
              <!-- The comments switcher -->


            

            <!-- The Footer -->

<footer
  aria-label="Site Info"
  class="
    d-flex flex-column justify-content-center text-muted
    flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3
  "
>
  <p>©
    <time>2025</time>

    
      <!--<a href="https://twitter.com/T_Ccooper">Theodore Cooper</a>.-->
      Theodore Cooper.
    

    
      <span
        data-bs-toggle="tooltip"
        data-bs-placement="top"
        title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author."
      >
      <!--All rights reserved.-->
      </span>
    
  </p>
</footer>

          </div>
        </div>

        <!-- The Search results -->

<div id="search-result-wrapper" class="d-flex justify-content-center d-none">
  <div class="col-11 content">
    <div id="search-hints">
      <!-- The trending tags list -->















  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
        
        

  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
    
  
    
    
    
    
      
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
  
    
    
    
    
      
        
        



  <section>
    <h2 class="panel-heading">Trending Tags</h2>
    <div class="d-flex flex-wrap mt-3 mb-1 me-3">
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/linux/">Linux</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/c-c/">C/C++</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/pentest/">Pentest</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/qt/">Qt</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/windows/">Windows</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/beautify/">Beautify</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/blogging/">Blogging</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/github/">Github</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/hexo/">Hexo</a>
      
        
        <a class="post-tag btn btn-outline-primary" href="/tags/math/">Math</a>
      
    </div>
  </section>


    </div>
    <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
  </div>
</div>

      </div>

      <aside aria-label="Scroll to Top">
        <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow">
          <i class="fas fa-angle-up"></i>
        </button>
      </aside>
    </div>

    <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>

    
      <aside
  id="notification"
  class="toast"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
  data-bs-animation="true"
  data-bs-autohide="false"
>
  <div class="toast-header">
    <button
      type="button"
      class="btn-close ms-auto"
      data-bs-dismiss="toast"
      aria-label="Close"
    ></button>
  </div>
  <div class="toast-body text-center pt-0">
    <p class="px-2 mb-3">A new version of content is available.</p>
    <button type="button" class="btn btn-primary" aria-label="Update">
      Update
    </button>
  </div>
</aside>

    

    <!-- JavaScripts -->
    <!-- JS selector for site. -->

<!-- commons -->



<!-- layout specified -->


  

  
    <!-- image lazy-loading & popup & clipboard -->
    
  















  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  

  
    

    

  



  <script src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.29.0/dist/tocbot.min.js"></script>







<script src="/assets/js/dist/post.min.js"></script>



<!-- Pageviews -->

  

  







    <!--
  Jekyll Simple Search loader
  See: <https://github.com/christian-fei/Simple-Jekyll-Search>
-->





<script>SimpleJekyllSearch({
    searchInput: document.getElementById('search-input'),
    resultsContainer: document.getElementById('search-results'),
    json: '/assets/js/data/search.json',
    searchResultTemplate: '  <article class="px-1 px-sm-2 px-lg-4 px-xl-0">    <header>      <h2><a href="{url}">{title}</a></h2>      <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1">        {categories}        {tags}      </div>    </header>    <p>{snippet}</p>  </article>',
    noResultsText: '<p class="mt-5">Oops! No results found.</p>',
    templateMiddleware: function(prop, value, template) {
      if (prop === 'categories') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`;
        }
      }

      if (prop === 'tags') {
        if (value === '') {
          return `${value}`;
        } else {
          return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`;
        }
      }
    }
  });
</script>

  </body>
</html>

